{% extends 'base.html' %}

{% load static %}

{% block body %}
<form method="POST" action="{% url 'community:promise:promise_vote' community.id promise.id %}">
    {% csrf_token %}
    <div class="container mt-4" style="max-width: 800px; margin: 0 auto; background-color: white; padding: 30px;">
        <img src="{% static 'index/images/masking_tape.png' %}" alt="ë§ˆìŠ¤í‚¹ í…Œì´í”„" class="masking_tape">
        <div class="text-center my-4">
            <h2><strong>ë§Œë‚  ìˆ˜ ìˆëŠ” ë‚ ì§œì— íˆ¬í‘œí•´ì£¼ì„¸ìš”!</strong></h2>
        </div>
        <div id="calendar" class="my-4 mx-auto" style="max-width: 800px; margin: 0 auto;"></div>
        
        <!--ì„ íƒëœ ë‚ ì§œë¥¼ ë‹´ì„ hidden input-->
        <input type="hidden" name="selected_dates" id="selected-dates">
        
        <div class="text-end my-4">
            <button type="submit" class="btn btn-outline-dark px-4 py-2"> ì„ íƒ ì™„ë£Œ </button>
        </div>
    </div>

</form>

<style>
    .container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
    }

    .masking_tape {
        position: absolute;
        top: -45px;
        left: 50%;
        transform: translateX(-50%) rotate(10deg);
        width: 50px;
        height: auto;
        z-index: 2;
        pointer-events: none;
  }

    /* FullCalendar ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
    .fc .fc-button {
        background-color: white;
        border: 2px solid #A39F95;
        color: black;
        font-weight: bold;
        font-size: 16px;
        box-shadow: none;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    /* ğŸ”§ ë²„íŠ¼ ì •ë ¬ ë° ìŠ¤íƒ€ì¼ */
    .fc-toolbar-chunk {
        display: flex;
        align-items: center;
        gap: 10px;  /* ë²„íŠ¼ ê°„ê²© */
    }

    /* ì˜¤ëŠ˜ ë²„íŠ¼ */
    .fc .fc-today-button {
        background-color: white !important;      
        color: black !important;                
        border: 1px solid #A39F95 !important;   
        border-radius: 6px !important;
        font-weight: bold !important;
        font-size: 15px !important;
    }

    .fc .fc-today-button:hover {
        background-color: #A39F95 !important;    
        color: black !important;
    }


    /* ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .fc .fc-prev-button,
    .fc .fc-next-button {
        background-color: white !important;   
        border: none !important;              
        border-radius: 0;
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: none;
    }

    /* ê¸°ì¡´ í…ìŠ¤íŠ¸ ì•„ì´ì½˜ ìˆ¨ê¹€ */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        display: none;
    }

    /* í™”ì‚´í‘œ (ì‚¼ê°í˜•) */
    .fc .fc-prev-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 12px solid #A39F95;
    }

    .fc .fc-next-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 12px solid #A39F95;
    }

    /* hover ì‹œ ë°°ê²½ ìœ ì§€ + í™”ì‚´í‘œ ìƒ‰ìƒë§Œ ë³€ê²½ */
    .fc .fc-prev-button:hover,
    .fc .fc-next-button:hover {
        background-color: #A39F95 !important;
    }

    .fc .fc-prev-button:hover::before {
        border-right-color: #A39F95;
    }

    .fc .fc-next-button:hover::before {
        border-left-color: #A39F95;
    }

    /* ì•„ì´ì½˜ ì‚¬ì´ì¦ˆ */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        font-size: 1.2rem;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ ê¹¨ê¸° (ì¤‘ì²© ë°°ê²½ ë°©ì§€) */
    .fc .fc-button-group {
        display: flex;
        gap: 10px;
    }

    /* íˆ´ë°” ì •ë ¬ */
    .fc-header-toolbar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    .fc-toolbar-promise_name {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
    }

    .fc-header-toolbar {
        justify-content: center;
        margin-bottom: 10px;
    }

    .fc .fc-scrollgrid,
    .fc .fc-scrollgrid > tbody,
    .fc .fc-scrollgrid > tbody > tr,
    .fc .fc-scrollgrid > tbody > tr > td {
        overflow: hidden;
    }
    
    .fc .fc-view-harness {
        overflow: hidden;
        border: 1px solid black !important;
        box-sizing: border-box !important;
        padding: 30px;

    }

    /* ê°€ì¥ ì•ˆìª½ í…Œì´ë¸”ì˜ í…Œë‘ë¦¬ ì—†ì• ê¸° (í…Œë‘ë¦¬ ì˜ë¦¼ ë°©ì§€) */
    .fc .fc-scrollgrid {
        border: none;
        border-collapse: collapse !important;  /* í…Œë‘ë¦¬ ê°„ê²©ì„ ìœ„í•´ í•„ìˆ˜ */
        border-spacing: 0 !important;
        background-color: white;
        margin-bottom: 3px !important;
    }
    
    /* ìš”ì¼ í—¤ë” ìŠ¤íƒ€ì¼ */
    .fc-col-header-cell-cushion {
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
    }
    /* í‰ì¼ ìƒ‰ ì§€ì • */
    .fc-col-header-cell:nth-child(2) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(3) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(4) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(5) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(6) .fc-col-header-cell-cushion,
    .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-daygrid-day-number {color: black;}

    /* í† ìš”ì¼ ìƒ‰ ì§€ì • */
    .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion,
    .fc-day-sat .fc-daygrid-day-number {color: blue;}
    
    /* ì¼ìš”ì¼ ìƒ‰ ì§€ì •*/
    .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion,
    .fc-day-sun .fc-daygrid-day-number {color: red;}

    /* ë‚ ì§œ ì…€ ì¹¸ í…Œë‘ë¦¬ ì œê±° */
    .fc .fc-daygrid-day,
    .fc .fc-scrollgrid td,
    .fc .fc-scrollgrid th {
        border: none !important;
    }
    .fc .fc-col-header {
        border-bottom: 1px solid #000000 !important;  /* ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥ */
    }
    
    .fc .fc-daygrid-day-frame {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80px;  
        padding: 0;
    }

    .fc .fc-daygrid-day-number {
        position: relative !important;  /* ê¸°ì¡´ absolute ì œê±° */
        font-weight: bold;
        font-size: 14px;
        z-index: 2;  /* ë°•ìŠ¤ë³´ë‹¤ ìœ„ì— */
    }
    
    .fc-event.vote-selected-day {
        background-color: rgba(163, 159, 149, 0.5);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        position: absolute;
        top: 5px;
        left: -12px;
        transform: translateX(-50%);
        z-index: 1;
        border: none;
        pointer-events: none;
    }

    .btn-outline-dark.px-4.py-2 {
        color: black;
        background-color: #A39F95;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        transition: all 0.2s ease;
    }
    /* ì˜¤ëŠ˜(today) ë‚ ì§œ ê¸°ë³¸ ë°°ê²½ ì œê±° */
    .fc-day-today {
        background-color: transparent !important;
    }

    /* ëª¨ë°”ì¼ ë²„ì „ */
    @media (max-width: 768px) {
        /* ì»¨í…Œì´ë„ˆ í’€í­ + íŒ¨ë”© ì¶•ì†Œ */
        .container {
            max-width: 100% !important;
            padding: 10px !important;
        }

        /* ë§ˆìŠ¤í‚¹ í…Œì´í”„ í¬ê¸°/ìœ„ì¹˜ */
        .masking_tape {
            width: 40px !important;
            top: -35px !important;
            left: 50% !important;
            transform: translateX(-50%) rotate(10deg) !important;
        }

        /* ìº˜ë¦°ë” full-width + ì¤‘ì•™ì •ë ¬ */
        #calendar {
            width: 100% !important;
            margin: 0 auto !important;
            padding: 0 8px !important;
        }

        .fc-toolbar-title {
            font-size: 25px !important;
        }

        /* ì„ íƒì™„ë£Œ ë²„íŠ¼ */
        .text-end {
            text-align: center !important;
            margin-top: 1rem !important;
        }

        .text-end .btn {
            width: 100% !important;
            padding: 12px !important;
            font-size: 1rem !important;
        }
    }

</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const start = "{{start_date}}";
        const end = "{{end_date}}";

        // ì„ íƒëœ ë‚ ì§œ ì €ì¥
        const selectedDates = new Set();

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            height: 'auto',
            selectable: false,
            validRange: {
                start: start,
                end: end
            },
            buttonText: {
                    today: 'ì˜¤ëŠ˜ë¡œ ê°€ê¸°'  
                },
            dayCellContent: function(arg) {
                return { html: String(arg.date.getDate()) };
            },
            dateClick: function(info) {
                const dateStr = info.dateStr;

                // ê¸°ì¡´ì— ì„ íƒëœ ë‚ ì§œë©´ í•´ì œ
                if (selectedDates.has(dateStr)) {
                    selectedDates.delete(dateStr);
                    removeHighlight(dateStr);
                } else {
                    selectedDates.add(dateStr);
                    addHighlight(dateStr);
                }
            },

            // ì´ˆê¸° ì´ë²¤íŠ¸ ë¹„ì›€
            events: []
        });

        calendar.render();

        // ìŠ¤í¬ë¡¤ë°” ì œê±°
        setTimeout(() => {
            const scrollers = document.querySelectorAll('.fc-scroller');
            scrollers.forEach(el => {
                el.style.overflow = 'hidden';
            });
        }, 100);

        function updateHiddenInput() {
            document.getElementById('selected-dates').value = Array.from(selectedDates).join(',');
        }

        // ë‚ ì§œ ê°•ì¡° ì´ë²¤íŠ¸ ì¶”ê°€
        function addHighlight(dateStr) {
            calendar.addEvent({
                start:dateStr,
                end: dateStr,
                allDay: true,
                classNames: ['vote-selected-day']
            });
            updateHiddenInput();
        }
        
        // ë‚ ì§œ ê°•ì¡° ì œê±°
        function removeHighlight(dateStr) {
            calendar.getEvents().forEach(e => {
                if (e.startStr === dateStr) {
                    e.remove();
                }
            });
            updateHiddenInput();
        }
    });
</script>
{% endblock %}