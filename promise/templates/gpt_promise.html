{% extends 'base.html' %}

{% block body %}
<div class="container mt-4">
    <!--약속명-->
    <div class="mb-3 d-flex align-items-center">
        <label class="form-label fw-bold me-2">약속명 : </label>
        <input type="text" class="form-control w-50 d-inline-block">
    </div>

    <!--시작일-->
    <div class="mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
            <span class="fw-bold">시작일 : </span>
            <select id="start-year" name="start-year" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for year in years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
            </select>
            <span>년</span>
            <select id="start-month" name="start-month" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for month in months %}<option value="{{ month }}">{{ month }}</option>{% endfor %}
            </select>
            <span>월</span>
            <select id="start-day" name="start-day" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for day in days %}<option value="{{ day }}">{{ day }}</option>{% endfor %}
            </select>
            <span>일</span>
        </div>

        <!--종료일-->
        <div class="d-flex align-items-center gap-2">
            <span class="fw-bold">종료일 : </span>
            <select id="end-year" name="end-year" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for year in years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
            </select>
            <span>년</span>
            <select id="end-month" name="end-month" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for month in months %}<option value="{{ month }}">{{ month }}</option>{% endfor %}
            </select>
            <span>월</span>
            <select id="end-day" name="end-day" class="form-select w-auto">
                <option selected disabled>선택</option>
                {% for day in days %}<option value="{{ day }}">{{ day }}</option>{% endfor %}
            </select>
            <span>일</span>
        </div>
    </div>

    <div id="calendar" class="my-4 mx-auto" style="max-width: 1000px; overflow: visible;"></div>

    <div class="text-end mt-4">
        <button class="btn btn-outline-dark px-4 py-2">다음</button>
    </div>
</div>

<style>
    .fc-daygrid-day-number { font-size: 1.2rem; font-weight: bold; }
    .fc-toolbar-title { font-size: 1.5rem; font-weight: bold; text-align: center; }
    .fc-header-toolbar { justify-content: center; margin-bottom: 10px; }
    .fc-col-header-cell-cushion { font-size: 16px; font-weight: bold; text-decoration: none; }
    .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion { color: red; }
    .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion { color: blue; }
    .fc-daygrid-day-frame { display: flex; justify-content: center; align-items: center; height: 80px; }
    #calendar { border: 2px solid black; padding: 10px; max-width: 600px; margin: 0 auto; }
    .container label { font-weight: bold; }
    .fc-event { pointer-events: none !important; }
    .fc-bg-event { z-index: 0 !important; }
</style>
{% endblock %}

{% block scripts %}
<script>
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
const todayStr = `${yyyy}-${mm}-${dd}`;
let calendar;

function renderCalendarHighlight(startYear, startMonth, startDay) {
    if (!calendar) return;

    const start = new Date(startYear, startMonth - 1, startDay);
    const startStr = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;

    calendar.getEvents().forEach(e => e.remove());
    calendar.addEvent({
        start: startStr,
        end: startStr,
        allDay: true,
        display: 'background',
        color: '#bee3f8'
    });
}

function disableEndPastDates() {
    const endYear = document.getElementById("end-year");
    const endMonth = document.getElementById("end-month");
    const endDay = document.getElementById("end-day");

    [...endYear.options].forEach(option => {
        if (option.value) {
            const y = parseInt(option.value);
            option.disabled = y < today.getFullYear();
        }
    });

    endYear.addEventListener("change", () => {
        const startYear = parseInt(document.getElementById("start-year").value);
        const startMonth = parseInt(document.getElementById("start-month").value);

        const y = parseInt(endYear.value);
        [...endMonth.options].forEach(option => {
            if (option.value) {
                const m = parseInt(option.value);
                const disableByYear = y === startYear && m < startMonth;
                const disableByToday = y === today.getFullYear() && m < today.getMonth() + 1;
                option.disabled = disableByYear || disableByToday;
            }
        });
        endMonth.value = "선택";
        endDay.value = "선택";
        disableEndDays();
    });

    endMonth.addEventListener("change", disableEndDays);

    function disableEndDays() {
        const y = parseInt(endYear.value);
        const m = parseInt(endMonth.value);
        if (!y || !m) return;

        const startYear = parseInt(document.getElementById("start-year").value);
        const startMonth = parseInt(document.getElementById("start-month").value);
        const startDay = parseInt(document.getElementById("start-day").value);
        if (!startYear || !startMonth || !startDay) return;

        const startDate = new Date(startYear, startMonth - 1, startDay);

        [...endDay.options].forEach(option => {
            if (option.value) {
                const d = parseInt(option.value);
                const endDate = new Date(y, m - 1, d);
                option.disabled = endDate < startDate || endDate < today;
            }
        });
    }

    endDay.addEventListener("change", () => {
        const y = parseInt(endYear.value);
        const m = parseInt(endMonth.value);
        const d = parseInt(endDay.value);
        if (!y || !m || !d) return;

        const startYear = parseInt(document.getElementById("start-year").value);
        const startMonth = parseInt(document.getElementById("start-month").value);
        const startDay = parseInt(document.getElementById("start-day").value);
        if (!startYear || !startMonth || !startDay) return;

        const endDate = new Date(y, m - 1, d);
        const startDate = new Date(startYear, startMonth - 1, startDay);

        if (endDate < startDate) {
            alert("종료일은 시작일보다 빠를 수 없습니다.");
            endDay.value = "선택";
        }
    });
}

document.addEventListener("DOMContentLoaded", () => {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: "ko",
        height: 'auto',
        selectable: true,
        validRange: { start: todayStr },
        events: []
    });
    calendar.render();

    ["start-year", "start-month", "start-day"].forEach(id => {
        document.getElementById(id).addEventListener("change", () => {
            const y = parseInt(document.getElementById("start-year").value);
            const m = parseInt(document.getElementById("start-month").value);
            const d = parseInt(document.getElementById("start-day").value);
            if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
                renderCalendarHighlight(y, m, d);
                disableEndPastDates();
            }
        });
    });

    disableEndPastDates();
});
</script>
{% endblock %}
