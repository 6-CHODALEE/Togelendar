{% extends 'base.html' %}

{% block body %}
<div class="container my-5">
    <div class="text-center mb-5">
        {% if all_voted %}
            <h2><strong>{{promise.promise_name}}</strong>의 약속 날짜가 정해졌어요!</h2>
        {% else %}
            <h2>아직 <strong>{{promise.promise_name}}</strong>의 약속 날짜 투표가 진행중이에요!</h2>
        {% endif %}
    </div>
    <div id="calendar" style="max-width: 800px; margin: 0 auto;"></div>
    {% if promise_result %}
        <div id="map" style="height: 400px; max-width: 800px; margin: 20px auto 0 auto;"></div>
    {% else %}
        <div style="text-align: center; margin: 20px auto; color: gray;">
            <p>아직 장소가 정해지지 않았습니다.</p>
        </div>
    {% endif %}
    <div style="max-width: 800px; margin: 10px auto 0 auto; display: flex; justify-content: flex-end; padding-right: 20px;">
        <a href="{% url 'community:community_detail' community.id %}" class="btn btn-outline-secondary btn-sm">
            커뮤니티로 이동하기
        </a>
        <a href="{% url 'community:promise:promiselocation:location' community.id promise.id %}" class="btn btn-outline-secondary btn-sm">
            장소 정하기
        </a>
    </div>
</div>

<style>
    .fc-day-today {
        background-color: transparent !important;
    }

    .fc-daygrid-day-frame {
        position: relative;
    }

    .fc-vote-count {
        font-size: 0.75rem;
        font-weight: bold;
        text-align: center;
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
    }
        
        /* 평일 색 지정 */
        .fc-col-header-cell:nth-child(2) .fc-col-header-cell-cushion,
        .fc-col-header-cell:nth-child(3) .fc-col-header-cell-cushion,
        .fc-col-header-cell:nth-child(4) .fc-col-header-cell-cushion,
        .fc-col-header-cell:nth-child(5) .fc-col-header-cell-cushion,
        .fc-col-header-cell:nth-child(6) .fc-col-header-cell-cushion,
        .fc-day-mon .fc-daygrid-day-number,
        .fc-day-tue .fc-daygrid-day-number,
        .fc-day-wed .fc-daygrid-day-number,
        .fc-day-thu .fc-daygrid-day-number,
        .fc-day-fri .fc-daygrid-day-number {color: black;}

        /* 토요일 색 지정 */
        .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion,
        .fc-day-sat .fc-daygrid-day-number {color: blue;}
        
        /* 일요일 색 지정*/
        .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion,
        .fc-day-sun .fc-daygrid-day-number {color: red;}
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        // 전체 투표 데이터 받아오기
        const allVotes = JSON.parse('{{all_vote_data|safe}}');
        const totalMembers = parseInt(`{{total_members|default:1}}`);

        // FullCalendar 초기화
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            initialDate: allVotes.length > 0 ? allVotes[0].date : undefined,
            events: allVotes.map(item => ({
                    start: item.date,
                    end: item.date,
                    allDay: true,
                    display: 'background',
                    color: `rgba(251, 211, 141, ${item.intensity})`,
                    extendedProps: {
                        count: item.count,
                    }
            })),
            eventDidMount: function(info) {
                const count = info.event.extendedProps.count;
                const dateCell = info.el.closest(".fc-daygrid-day");
                const frame = dateCell ? dateCell.querySelector(".fc-daygrid-day-frame") : null;

                if (dateCell && count >0) {
                    const text = document.createElement("div");
                    text.className = "fc-vote-count";

                    if (count === 1) {
                        text.innerText = "1명 가능";
                        text.style.color = "blue";
                    } else if (count === totalMembers) {
                        text.innerText = "모두 가능";
                        text.style.color = "red";
                    } else {
                        text.innerText = `${count}명 가능`;
                        text.style.color = "blue"
                    }

                    frame.appendChild(text);
                }
            }
        });

        calendar.render();
    });
    
    var centerLat = parseFloat("{{ center_latitude|default:'37.5665' }}");
    var centerLng = parseFloat("{{ center_longitude|default:'126.9780' }}");

    var map = L.map('map').setView([centerLat, centerLng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 중간지점 마커
    L.marker([centerLat, centerLng]).addTo(map)
        .bindPopup('약속 중간지점').openPopup();

    // ⭐ 유저 위치들 마커 추가
    const userLocations = JSON.parse('{{ user_locations|safe }}');
    userLocations.forEach(user => {
        if (user.latitude !== null && user.longitude !== null) {
            L.circleMarker([user.latitude, user.longitude], {
                radius: 8,         // 크기
                color: 'red',      // 테두리 색
                fillColor: 'red',  // 채움 색
                fillOpacity: 1     // 채움 투명도
            }).addTo(map)
            .bindPopup(`${user.username}의 위치`);
        }
    });

    document.getElementById('location-button').addEventListener('click', function(e) {
        e.preventDefault();

        fetch("{% url 'community:promise:promiselocation:location' community.id promise.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공: 결과 페이지로 이동
                window.location.href = data.redirect_url;
            } else {
                // 실패: 메시지 팝업
                alert(data.message);
            }
        })
        .catch(error => {
            alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
        });
    });
</script>
<!-- ✅ Django messages 처리 (JS 블록 바깥에서 별도 실행) -->
{% if messages %}
<script>
    {% for message in messages %}
        alert("{{ message }}");
    {% endfor %}
</script>
{% endif %}
{% endblock %}