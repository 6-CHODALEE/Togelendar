{% extends 'base.html' %}

{% block body %}
<div class="container my-5">
    <div class="text-center mb-5">
        {% if all_voted %}
            <h2><strong>{{promise.promise_name}}</strong>의 약속 날짜가 정해졌어요!</h2>
        {% else %}
            <h2>아직 <strong>{{promise.promise_name}}</strong>의 약속 날짜 투표가 진행중이에요!</h2>
        {% endif %}
    </div>

    <div id="calendar" style="max-width: 800px; margin: 0 auto;"></div>

        {% if promise_result %}
        <div id="map" style="height: 400px; max-width: 800px; margin: 20px auto 0 auto;"></div>

        <div class="mt-4" style="max-width: 800px; margin: 0 auto;">
            <h4 class="mb-3">중간지점 주변 장소 추천 (반경 500m)</h4>

            <!-- 카테고리 버튼들 -->
            <div class="mb-3 text-center" id="category-buttons">
                <button data-type="all" class="btn btn-sm me-2 {% if selected_type == 'all' %}btn-dark{% else %}btn-outline-dark{% endif %}">전체</button>
                <button data-type="cafe" class="btn btn-sm me-2 {% if selected_type == 'cafe' %}btn-primary{% else %}btn-outline-primary{% endif %}">카페</button>
                <button data-type="restaurant" class="btn btn-sm me-2 {% if selected_type == 'restaurant' %}btn-danger{% else %}btn-outline-danger{% endif %}">음식점</button>
                <button data-type="convenience_store" class="btn btn-sm me-2 {% if selected_type == 'convenience_store' %}btn-success{% else %}btn-outline-success{% endif %}">편의점</button>
                <button data-type="supermarket" class="btn btn-sm me-2 {% if selected_type == 'supermarket' %}btn-warning text-dark{% else %}btn-outline-warning{% endif %}">마트</button>
                <button data-type="subway_station" class="btn btn-sm me-2 {% if selected_type == 'subway_station' %}btn-info text-white{% else %}btn-outline-info{% endif %}">지하철</button>
            </div>

            <!-- ✅ 장소 리스트 조건부 출력 -->
            {% if places and places|length > 0 %}
            <ul class="list-group" id="place-list">
                {% for place in places %}
                <li class="list-group-item place-item" data-type="{{ place.type }}" data-name="{{ place.name }}">
                    <strong>{{ place.name }}</strong>
                    <span class="badge bg-secondary">{{ place.type }}</span><br>
                    {{ place.address }}<br>
                    {% if place.rating %} 평점: {{ place.rating }} {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="text-center text-muted mt-2">
                <p>선택한 카테고리에 해당하는 장소가 없습니다.</p>
            </div>
            {% endif %}
        </div>
    {% else %}
        <div style="text-align: center; margin: 20px auto; color: gray;">
            <p>아직 장소가 정해지지 않았습니다.</p>
        </div>
    {% endif %}

    <div style="max-width: 800px; margin: 10px auto 0 auto; display: flex; justify-content: flex-end; padding-right: 20px;">
        <a href="{% url 'community:community_detail' community.id %}" class="btn btn-outline-secondary btn-sm">
            커뮤니티로 이동하기
        </a>
        <a href="{% url 'community:promise:promiselocation:location' community.id promise.id %}" class="btn btn-outline-secondary btn-sm" id="location-button">
            장소 정하기
        </a>
    </div>
</div>

<style>
    .fc-day-today { background-color: transparent !important; }
    .fc-daygrid-day-frame { position: relative; }
    .fc-vote-count {
        font-size: 0.75rem; font-weight: bold; text-align: center;
        position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
        width: 100%;
    }
    .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion,
    .fc-day-sun .fc-daygrid-day-number { color: red; }
    .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion,
    .fc-day-sat .fc-daygrid-day-number { color: blue; }
    .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-daygrid-day-number { color: black; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const allVotes = JSON.parse('{{ all_vote_data|safe }}');
    const totalMembers = parseInt(`{{ total_members|default:1 }}`);

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        initialDate: allVotes.length > 0 ? allVotes[0].date : undefined,
        events: allVotes.map(item => ({
            start: item.date,
            end: item.date,
            allDay: true,
            display: 'background',
            color: `rgba(251, 211, 141, ${item.intensity})`,
            extendedProps: { count: item.count }
        })),
        eventDidMount: function(info) {
            const count = info.event.extendedProps.count;
            const frame = info.el.closest(".fc-daygrid-day")?.querySelector(".fc-daygrid-day-frame");
            if (frame && count > 0) {
                const text = document.createElement("div");
                text.className = "fc-vote-count";
                text.innerText = count === totalMembers ? "모두 가능" : `${count}명 가능`;
                text.style.color = count === totalMembers ? "red" : "blue";
                frame.appendChild(text);
            }
        }
    });
    calendar.render();

    // 지도 초기화
    const map = L.map('map').setView([
        parseFloat("{{ center_latitude|default:'37.5665' }}"),
        parseFloat("{{ center_longitude|default:'126.9780' }}")
    ], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([{{ center_latitude }}, {{ center_longitude }}]).addTo(map).bindPopup('약속 중간지점').openPopup();

    // 유저 위치 마커
    const userLocations = JSON.parse('{{ user_locations|safe }}');
    userLocations.forEach(user => {
        if (user.latitude !== null && user.longitude !== null) {
            L.circleMarker([user.latitude, user.longitude], {
                radius: 8, color: 'red', fillColor: 'red', fillOpacity: 1
            }).addTo(map).bindPopup(`${user.username}의 위치`);
        }
    });

    // 장소 마커
    const typeColors = {
        cafe: 'blue', restaurant: 'red',
        convenience_store: 'green', supermarket: 'orange',
        subway_station: 'purple'
    };
    const markerMap = {}; // 클릭 시 접근 용도

    const places = JSON.parse(`{{ places_json|safe }}`);
    places.forEach(place => {
        const color = typeColors[place.type] || 'gray';
        const lat = place.location.lat;
        const lng = place.location.lng;

        const marker = L.circleMarker([lat, lng], {
            radius: 8, color: color, fillColor: color, fillOpacity: 0.8
        }).addTo(map).bindPopup(`${place.name}<br><small>${place.address}</small>`);

        markerMap[place.name] = marker;
    });

    // 스크롤 유지용 버튼 클릭 필터링
    document.querySelectorAll('#category-buttons button').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            const type = this.dataset.type;
            const url = new URL(window.location.href);
            url.searchParams.set('type', type);
            history.pushState(null, '', url);  // 주소만 바꿈 (스크롤 안 튐)
            location.reload();  // JS로 리로드하면 스크롤 위치 유지됨
        });
    });

    // 장소 정하기 버튼
    document.getElementById('location-button')?.addEventListener('click', function(e) {
        e.preventDefault();
        fetch("{% url 'community:promise:promiselocation:location' community.id promise.id %}", {
            method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) window.location.href = data.redirect_url;
            else alert(data.message);
        })
        .catch(() => alert('서버 오류가 발생했습니다. 다시 시도해주세요.'));
    });
});
</script>

{% if messages %}
<script>
    {% for message in messages %}
        alert("{{ message }}");
    {% endfor %}
</script>
{% endif %}
{% endblock %}