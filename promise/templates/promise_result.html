{% extends 'base.html' %}

{% block body %}
<div class="container mt-4" style="max-width: 800px; margin: 0 auto; background-color: white; padding: 30px;">
    <div class="text-center mb-5" style="padding: 10px;">
        {% if all_voted %}
            <h2><strong>{{promise.promise_name}}</strong>의 약속 날짜가 정해졌어요!</h2>
        {% else %}
            <h2><strong>아직 투표가 진행중이에요!</strong></h2>
        {% endif %}
    </div>

    <div id="calendar" style="max-width: 800px; margin: 0 auto;"></div>

    {% if promise_result and is_location_decided %}
    <div id="map" style="height: 400px; max-width: 800px; margin: 20px auto 0 auto;"></div>

    <div class="mt-4" style="max-width: 800px; margin: 0 auto;">
        <h4 class="mb-3">중간지점 주변 장소 추천 (반경 500m)</h4>

        <!-- 카테고리 버튼들 -->
        <div class="mb-3 text-center" id="category-buttons">
            <button data-type="all" class="btn btn-sm me-2 btn-dark">전체</button>
            <button data-type="cafe" class="btn btn-sm me-2 btn-outline-primary">카페</button>
            <button data-type="restaurant" class="btn btn-sm me-2 btn-outline-danger">음식점</button>
            <button data-type="convenience_store" class="btn btn-sm me-2 btn-outline-success">편의점</button>
            <button data-type="subway_station" class="btn btn-sm me-2 btn-outline-info">지하철</button>
        </div>

        {% if places and places|length > 0 %}
        <ul class="list-group" id="place-list">
            {% for place in places %}
            <li class="list-group-item place-item" data-type="{{ place.type }}" data-name="{{ place.name }}">
                <strong>{{ place.name }}</strong>
                <span class="badge bg-secondary">{{ place.type }}</span><br>
                {{ place.address }}<br>
                {% if place.rating %} 평점: {{ place.rating }} {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="text-center text-muted mt-2">
            <p>선택한 카테고리에 해당하는 장소가 없습니다.</p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div style="text-align: center; margin: 20px auto; color: gray;">
        <p>아직 장소가 정해지지 않았습니다.</p>
    </div>
    {% endif %}

    <div style="max-width: 800px; margin: 10px auto 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
        <!-- 왼쪽: 약속 취소 -->
        <div>
            <a href="#" class="btn btn-outline-danger btn-sm" id="promise_delete-button" style="border-radius: 0;">
                약속 취소하기
            </a>
        </div>

        <!-- 오른쪽: 커뮤니티 / 장소 -->
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'community:community_detail' community.id %}" class="btn btn-outline-secondary btn-sm" style="border-radius: 0; border: 1px solid #A39F95;">
                커뮤니티로 이동하기
            </a>
            <a href="#" class="btn btn-outline-secondary btn-sm" id="location-button">
                장소 정하기
            </a>
        </div>
    </div>
</div>

<style>
    /* FullCalendar 버튼 공통 스타일 초기화 */
    .fc .fc-button {
        background-color: white;
        border: 2px solid #A39F95;
        color: black;
        font-weight: bold;
        font-size: 16px;
        box-shadow: none;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    /* 🔧 버튼 정렬 및 스타일 */
    .fc-toolbar-chunk {
        display: flex;
        align-items: center;
        gap: 10px;  /* 버튼 간격 */
    }

    /* 오늘 버튼 */
    .fc .fc-today-button {
        background-color: white !important;      
        color: black !important;                
        border: 2px solid #A39F95 !important;   
        border-radius: 0 !important;
        padding: 6px 20px !important;
        font-weight: bold !important;
        font-size: 15px !important;
    }

    .fc .fc-today-button:hover {
        background-color: white !important;    
        color: black !important;
    }


    /* 이전/다음 버튼 공통 스타일 */
    .fc .fc-prev-button,
    .fc .fc-next-button {
        background-color: white !important;   
        border: none !important;              
        border-radius: 0;                 
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: none;
    }

    /* 기존 텍스트 아이콘 숨김 */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        display: none;
    }

    /* 화살표 (삼각형) */
    .fc .fc-prev-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 12px solid #A39F95;
    }

    .fc .fc-next-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 12px solid #A39F95;
    }

    /* hover 시 배경 유지 + 화살표 색상만 변경 */
    .fc .fc-prev-button:hover,
    .fc .fc-next-button:hover {
        background-color: white !important;
    }

    .fc .fc-prev-button:hover::before {
        border-right-color: #A39F95;
    }

    .fc .fc-next-button:hover::before {
        border-left-color: #A39F95;
    }

    /* 아이콘 사이즈 */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        font-size: 1.2rem;
    }

    /* 버튼 그룹 깨기 (중첩 배경 방지) */
    .fc .fc-button-group {
        display: flex;
        gap: 10px;
    }

    /* 툴바 정렬 */
    .fc-header-toolbar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    .fc-toolbar-promise_name {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
    }

    .fc-header-toolbar {
        justify-content: center;
        margin-bottom: 10px;
    }

    .fc .fc-scrollgrid,
    .fc .fc-scrollgrid > tbody,
    .fc .fc-scrollgrid > tbody > tr,
    .fc .fc-scrollgrid > tbody > tr > td {
        
        overflow: hidden;
    }
    
    .fc .fc-view-harness {
        border: 1px solid #000000;       /* 검정 테두리 */
        overflow: hidden;                /* 내부 넘침 방지 */
        box-sizing: border-box;          /* 테두리 포함 레이아웃 */
        padding: 16px;               /* 테두리와 내용 사이 여백 */
        background-color: white;
    }

    /* 가장 안쪽 테이블의 테두리 없애기 (테두리 잘림 방지) */
    .fc .fc-scrollgrid {
        border: 1px solid black;
        border-collapse: separate !important;
        border-spacing: 16px;  /* 테두리와 셀 간격 */
        background-color: white;
    }
    
    /* 요일 헤더 스타일 */
    .fc-col-header-cell-cushion {
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
    }

    .fc-day-today { background-color: transparent !important; }
    .fc-daygrid-day-frame { position: relative; }
    .fc-vote-count {
        font-size: 0.75rem; font-weight: bold; text-align: center;
        position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
        width: 100%;
    }
    /* 평일 색 지정 */
    .fc-col-header-cell:nth-child(2) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(3) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(4) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(5) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(6) .fc-col-header-cell-cushion,
    .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-daygrid-day-number {color: black;}

    /* 토요일 색 지정 */
    .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion,
    .fc-day-sat .fc-daygrid-day-number {color: blue;}
    
    /* 일요일 색 지정*/
    .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion,
    .fc-day-sun .fc-daygrid-day-number {color: red;}
    /* 날짜 셀 칸 테두리 제거 */
    .fc .fc-daygrid-day,
    .fc .fc-scrollgrid td,
    .fc .fc-scrollgrid th {
        border: none !important;
    }
    .fc .fc-col-header {
        border-bottom: 1px solid #000000 !important;  /* 원하는 색으로 조절 가능 */
    }
    
    .fc .fc-daygrid-day-frame {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80px;  
        padding: 0;
    }

    .fc .fc-daygrid-day-number {
        position: relative !important;  /* 기존 absolute 제거 */
        font-weight: bold;
        font-size: 14px;
        z-index: 2;  /* 박스보다 위에 */
    }

    .fc-event.vote-dot {
        background-color: rgba(163, 159, 149, 0.5);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        position: absolute;
        top: -5px;
        left: -20px;
        transform: translateX(-50%);
        z-index: 1;
        border: none;
        pointer-events: none;
    }

    #location-button {
        background-color: #A39F95;
        border: none;
        border-radius: 0;
        color: black;
        padding: 6px 14px;
    }

    .btn-outline-secondary {
        background-color: #ffffff;
        border-color: #A39F95;
        color: black;
        padding: 6px 14px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const allVotes = JSON.parse('{{ all_vote_data|safe }}');
    const totalMembers = parseInt(`{{ total_members|default:1 }}`);

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        initialDate: allVotes.length > 0 ? allVotes[0].date : undefined,
        events: allVotes.map(item => ({
            start: item.date,
            end: item.date,
            allDay: true,
            classNames: ['vote-dot'],  // ✅ 원형 표시용 클래스
            extendedProps: { count: item.count }
        })),
        eventDidMount: function(info) {
            const count = info.event.extendedProps.count;
            const frame = info.el.closest(".fc-daygrid-day")?.querySelector(".fc-daygrid-day-frame");
            if (frame && count > 0) {
                const text = document.createElement("div");
                text.className = "fc-vote-count";
                text.innerText = count === totalMembers ? "모두 가능" : `${count}명 가능`;
                text.style.color = count === totalMembers ? "red" : "blue";
                frame.appendChild(text);
            }
        }
    });
    calendar.render();

    // 스크롤바 제거
    setTimeout(() => {
        const scrollers = document.querySelectorAll('.fc-scroller');
        scrollers.forEach(el => {
            el.style.overflow = 'hidden';
        });
    }, 100);

    {% if is_location_decided %}
    const map = L.map('map').setView([
        parseFloat("{{ center_latitude|default:'37.5665' }}"),
        parseFloat("{{ center_longitude|default:'126.9780' }}")
    ], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([{{ center_latitude }}, {{ center_longitude }}]).addTo(map).bindPopup('약속 중간지점').openPopup();

    const userLocations = JSON.parse('{{ user_locations|safe }}');
    userLocations.forEach(user => {
        if (user.latitude !== null && user.longitude !== null) {
            L.circleMarker([user.latitude, user.longitude], {
                radius: 8, color: 'red', fillColor: 'red', fillOpacity: 1
            }).addTo(map).bindPopup(`${user.username}의 위치`);
        }
    });

    const typeColors = {
        cafe: 'blue', restaurant: 'red',
        convenience_store: 'green', supermarket: 'orange',
        subway_station: 'purple'
    };

    const allMarkers = [];
    const places = JSON.parse(`{{ places_json|safe }}`);
    places.forEach(place => {
        const color = typeColors[place.type] || 'gray';
        const lat = place.location.lat;
        const lng = place.location.lng;

        const marker = L.circleMarker([lat, lng], {
            radius: 8, color: color, fillColor: color, fillOpacity: 0.8
        }).addTo(map).bindPopup(`${place.name}<br><small>${place.address}</small>`);

        marker.type = place.type;
        marker.name = place.name;
        allMarkers.push(marker);
    });

    document.querySelectorAll('#category-buttons button').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            const type = this.dataset.type;

            // 마커 필터링
            allMarkers.forEach(marker => {
                if (type === 'all' || marker.type === type) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });

            // 리스트 필터링
            document.querySelectorAll('#place-list .place-item').forEach(item => {
                const itemType = item.dataset.type;
                item.style.display = (type === 'all' || itemType === type) ? 'block' : 'none';
            });

            // 버튼 UI 갱신
            document.querySelectorAll('#category-buttons button').forEach(btn => {
                btn.classList.remove('btn-dark', 'btn-primary', 'btn-danger', 'btn-success', 'btn-info', 'text-white');
                btn.classList.add('btn-outline-dark', 'btn-outline-primary', 'btn-outline-danger', 'btn-outline-success', 'btn-outline-info');
            });

            if (type === 'all') this.classList.replace('btn-outline-dark', 'btn-dark');
            if (type === 'cafe') this.classList.replace('btn-outline-primary', 'btn-primary');
            if (type === 'restaurant') this.classList.replace('btn-outline-danger', 'btn-danger');
            if (type === 'convenience_store') this.classList.replace('btn-outline-success', 'btn-success');
            if (type === 'subway_station') this.classList.replace('btn-outline-info', 'btn-info');
            this.classList.add('text-white');
        });
    });
    {% endif %}

    const locationBtn = document.getElementById('location-button');
    if (locationBtn) {
        locationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fetch("{% url 'community:promise:promiselocation:location' community.id promise.id %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.message);
                }
            })
            .catch(() => alert('서버 오류가 발생했습니다. 다시 시도해주세요.'));
        });
    }
    document.getElementById("promise_delete-button").addEventListener("click", function (e) {
        e.preventDefault();
        if (!confirm("정말로 이 약속을 삭제하시겠습니까?")) return;

        fetch(`/community/{{ community.id }}/promise/{{ promise.id }}/delete/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("약속이 삭제되었습니다.");
                window.location.href = "{% url 'community:community_detail' community.id %}";
            } else {
                alert("삭제에 실패했습니다.");
            }
        })
        .catch(err => {
            console.error("삭제 요청 오류", err);
            alert("서버 오류 발생");
        });
    });
});
</script>

{% if messages %}
<script>
    {% for message in messages %}
        alert("{{ message }}");
    {% endfor %}
</script>
{% endif %}
{% endblock %}