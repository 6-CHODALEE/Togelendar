{% extends 'base.html' %}

{% load static %}

{% block body %}
<form method="POST" action="">
    {% csrf_token %}
    
    <div class="container mt-4" style="max-width: 800px; margin: 0 auto; background-color: white; padding: 30px;">
        <img src="{%static 'index/images/masking_tape.png' %}" alt="ë§ˆìŠ¤í‚¹ í…Œì´í”„" class="masking_tape">
        <div class="text-center mb-5">
            <h2><strong>ì–¸ì œ ë§Œë‚ ë˜?</strong></h2>
        </div>

        {% if message %}
            <div style="white-space: pre-line; color: red; font-weight: bold; text-align: center; margin-bottom: 20px;">
                {{ message }}
            </div>
        {% endif %}
        
        <div class="row mb-3 align-items-center">
            <label class="col-2 col-form-label text-end fw-bold">ì•½ì†ëª… :</label>
                <div class="col-10">
                    <input type="text" class="form-control w-50" name="promise_name" required>
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label class="col-2 col-form-label text-end fw-bold">ì‹œì‘ì¼ :</label>
            <div class="col-10 d-flex align-items-center gap-2">
                <select id="start-year" name="start-year" class="form-select w-auto" >
                    <option disabled selected>ì„ íƒ</option>
                        {% for year in years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                </select>
                <span>ë…„</span>

                <select id="start-month" name="start-month" class="form-select w-auto">
                    <option disabled selected>ì„ íƒ</option>
                        {% for month in months %}
                            <option value="{{ month }}">{{ month }}</option>
                        {% endfor %}
                </select>
                <span>ì›”</span>

                <select id="start-day" name="start-day" class="form-select w-auto">
                    <option disabled selected>ì„ íƒ</option>
                        {% for day in days %}
                            <option value="{{ day }}">{{ day }}</option>
                        {% endfor %}
                </select>
                <span>ì¼</span>
            </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label class="col-2 col-form-label text-end fw-bold">ì¢…ë£Œì¼ :</label>
            <div class="col-10 d-flex align-items-center gap-2">
                    <select id="end-year" name="end-year" class="form-select w-auto">
                    <option disabled selected>ì„ íƒ</option>
                        {% for year in years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                <span>ë…„</span>

                <select id="end-month" name="end-month" class="form-select w-auto">
                    <option disabled selected>ì„ íƒ</option>
                        {% for month in months %}
                            <option value="{{ month }}">{{ month }}</option>
                        {% endfor %}
                </select>
                <span>ì›”</span>

                <select id="end-day" name="end-day" class="form-select w-auto">
                    <option disabled selected>ì„ íƒ</option>
                        {% for day in days %}
                            <option value="{{ day }}">{{ day }}</option>
                        {% endfor %}
                </select>
                <span>ì¼</span>
            </div>
            </div>
        
        <!--ë‹¬ë ¥ FullCalendar ì‚¬ìš©-->
        <div id="calendar" class="my-4 mx-auto" style="max-width: 800px; margin: 0 auto;"></div>
        
        <!--ì œì¶œ ë²„íŠ¼-->
        <div class="text-end my-4">
            <button type="submit" id="submit-btn" class="btn btn-outline-dark px-4 py-2">ë‹¤ìŒ</button>
        </div>
    </div>
</form>
    
<style>
    .masking_tape {
        position: absolute;
        top: -45px;
        left: 50%;
        transform: translateX(-50%) rotate(10deg);
        width: 50px;
        height: auto;
        z-index: 2;
        pointer-events: none;
  }

    .form-control,
    .form-select {
        border-radius: 0;
    }

    /* FullCalendar ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
    .fc .fc-button {
        background-color: white;
        border: 2px solid #A39F95;
        color: black;
        font-weight: bold;
        font-size: 16px;
        box-shadow: none;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    /* ğŸ”§ ë²„íŠ¼ ì •ë ¬ ë° ìŠ¤íƒ€ì¼ */
    .fc-toolbar-chunk {
        display: flex;
        align-items: center;
        gap: 10px;  /* ë²„íŠ¼ ê°„ê²© */
    }

    /* ì˜¤ëŠ˜ ë²„íŠ¼ */
    .fc .fc-today-button {
        background-color: white !important;      
        color: black !important;
        border: 1px solid #A39F95 !important;   
        border-radius: 0;
        font-weight: bold;
        font-size: 15px;
    }

    .fc .fc-today-button:hover {
        background-color: #A39F95 !important;    
        color: black !important;
    }


    /* ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .fc .fc-prev-button,
    .fc .fc-next-button {
        background-color: white !important;   
        border: none;
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: none;
    }

    /* ê¸°ì¡´ í…ìŠ¤íŠ¸ ì•„ì´ì½˜ ìˆ¨ê¹€ */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        display: none;
    }

    /* í™”ì‚´í‘œ (ì‚¼ê°í˜•) */
    .fc .fc-prev-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 12px solid #A39F95;
    }

    .fc .fc-next-button::before {
        content: "";
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 12px solid #A39F95;
    }

    /* hover ì‹œ ë°°ê²½ ìœ ì§€ + í™”ì‚´í‘œ ìƒ‰ìƒë§Œ ë³€ê²½ */
    .fc .fc-prev-button:hover,
    .fc .fc-next-button:hover {
        background-color: white !important;
    }

    .fc .fc-prev-button:hover::before {
        border-right-color: #A39F95;
    }

    .fc .fc-next-button:hover::before {
        border-left-color: #A39F95;
    }

    /* ì•„ì´ì½˜ ì‚¬ì´ì¦ˆ */
    .fc .fc-prev-button .fc-icon,
    .fc .fc-next-button .fc-icon {
        font-size: 1.2rem;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ ê¹¨ê¸° (ì¤‘ì²© ë°°ê²½ ë°©ì§€) */
    .fc .fc-button-group {
        display: flex;
        gap: 10px;
    }

    /* íˆ´ë°” ì •ë ¬ */
    .fc-header-toolbar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
    }
    .fc-toolbar-promise_name {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
    }

    .fc-header-toolbar {
        justify-content: center;
        margin-bottom: 10px;
    }

    .fc .fc-scrollgrid,
    .fc .fc-scrollgrid > tbody,
    .fc .fc-scrollgrid > tbody > tr,
    .fc .fc-scrollgrid > tbody > tr > td {
        overflow: hidden;
    }
    
    .fc .fc-view-harness {
        border: 1px solid black;       /* ê²€ì • í…Œë‘ë¦¬ */
        overflow: hidden;                /* ë‚´ë¶€ ë„˜ì¹¨ ë°©ì§€ */
        box-sizing: border-box;          /* í…Œë‘ë¦¬ í¬í•¨ ë ˆì´ì•„ì›ƒ */
        padding: 30px;               /* í…Œë‘ë¦¬ì™€ ë‚´ìš© ì‚¬ì´ ì—¬ë°± */
    }

    /* ê°€ì¥ ì•ˆìª½ í…Œì´ë¸”ì˜ í…Œë‘ë¦¬ ì—†ì• ê¸° (í…Œë‘ë¦¬ ì˜ë¦¼ ë°©ì§€) */
    .fc .fc-scrollgrid {
        border-radius: 0; 
        border: none;
        border-collapse: collapse;
        border-spacing: 0;
        margin-bottom: 3px !important;
    }
    
    /* ìš”ì¼ í—¤ë” ìŠ¤íƒ€ì¼ */
    .fc-col-header-cell-cushion {
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
    }

    /* í‰ì¼ ìƒ‰ ì§€ì • */
    .fc-col-header-cell:nth-child(2) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(3) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(4) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(5) .fc-col-header-cell-cushion,
    .fc-col-header-cell:nth-child(6) .fc-col-header-cell-cushion,
    .fc-day-mon .fc-daygrid-day-number,
    .fc-day-tue .fc-daygrid-day-number,
    .fc-day-wed .fc-daygrid-day-number,
    .fc-day-thu .fc-daygrid-day-number,
    .fc-day-fri .fc-daygrid-day-number {color: black;}

    /* í† ìš”ì¼ ìƒ‰ ì§€ì • */
    .fc-col-header-cell:nth-child(7) .fc-col-header-cell-cushion,
    .fc-day-sat .fc-daygrid-day-number {color: blue;}
    
    /* ì¼ìš”ì¼ ìƒ‰ ì§€ì •*/
    .fc-col-header-cell:nth-child(1) .fc-col-header-cell-cushion,
    .fc-day-sun .fc-daygrid-day-number {color: red;}
 
    

    /* ë‚ ì§œ ì…€ ì¹¸ í…Œë‘ë¦¬ ì œê±° */
    .fc .fc-daygrid-day,
    .fc .fc-scrollgrid td,
    .fc .fc-scrollgrid th {
        border: none !important;
    }
    .fc .fc-col-header {
        border-bottom: 1px solid #000000 !important;  /* ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥ */
    }
    
    .fc .fc-daygrid-day-frame {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80px;  
        padding: 0;
    }

    /* ë‚ ì§œ í´ë¦­ ì‹œ ìƒê¸°ëŠ” íŒŒë€ outline ë° ë°°ê²½ ì œê±° */
    .fc-daygrid-day-frame:focus-within {
        outline: none !important;
        background: none !important;
        box-shadow: none !important;
    }

    /* ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì‹œ ìƒê¸°ëŠ” ë°°ê²½ ì œê±° */
    .fc-highlight {
        background: none !important;
    }

    .fc .fc-daygrid-day-number {
        position: relative !important;  /* ê¸°ì¡´ absolute ì œê±° */
        font-weight: bold;
        font-size: 14px;
        z-index: 2;  /* ë°•ìŠ¤ë³´ë‹¤ ìœ„ì— */
    }

    .form-section select,
    .form-section input {
        vertical-align: middle;
    }

    .form-section {
        display: inline-block;
        width: auto;
        margin-right: 4px;
        font-size: 1.2rem;
    }

    .form-section label {
        min-width: 80px;
        display: inline-block;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
    }

    /* í¼ ì „ì²´ ìŠ¤íƒ€ì¼ ì •ëˆ */
    .container label {
        font-weight: bold;
    }

    .mb-3 {
        width: 100%;
        max-width: 600px;
    }

    .fc-event {
        pointer-events: none !important;
    }
    .fc-bg-event {
        z-index: 0 !important;
    }

    .fc .selected-day {
        background: none !important;
    }
 
    .fc-daygrid-event-harness {
        background-color: transparent !important;
        border: none !important;
    }

    .fc-event.selected-day {
        background-color: rgba(255, 184, 255, 0.5) !important;
        border: none;
        pointer-events: none;
        border-radius: 0 !important;
        height: 28px;
        display: block;
        position: absolute;
        top: 36px; /* ì¤‘ì•™ ì•„ë˜ ìœ„ì¹˜ ì¡°ì • */
        left: 0;
        right: 0;
        z-index: 1;
    }

    .fc-event.selected-day-start {
        background-color: rgba(163, 159, 149, 0.5) !important;
        border-radius: 50px 0 0 50px !important;
        height: 28px;
        width: calc(100% + 25px); /* ì…€ë³´ë‹¤ ì‚´ì§ ê¸¸ê²Œ */
        position: absolute;
        top: 10px;
        left: -27px;                /* ë°˜ ì…€ í¬ê¸°ë§Œí¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
        z-index: 1;
    }

    .fc-event.selected-day-middle {
        background-color: rgba(163, 159, 149, 0.5) !important;
        border-radius: 0 !important;
        height: 28px;
        width: calc(100% + 25px);
        position: absolute;
        top: 10px;
        left: -27px;
        z-index: 1;
    }

    .fc-event.selected-day-end {
        background-color: rgba(163, 159, 149, 0.5) !important;
        border-radius: 0 50px 50px 0 !important;
        height: 28px;
        width: calc(100% + 25px);
        position: absolute;
        top: 10px;
        left: -27px;
        z-index: 1;
    }
    
    .fc-event.selected-day-single {
        background-color: rgba(163, 159, 149, 0.5) !important;
        border-radius: 50% !important;
        width: 28px;
        height: 28px;
        position: absolute;
        top: 10px;              /* ë‚ ì§œ ìˆ«ì ìœ„ì¹˜ ê¸°ì¤€ ìˆ˜ì§ ì¡°ì • */
        left: -14px;
        transform: translateX(-50%);
        z-index: 1;
    }

    .fc-event-start.selected-day {
        border-top-left-radius: 20px !important;
        border-bottom-left-radius: 20px !important;
    }

    .fc-event-end.selected-day {
        border-top-right-radius: 20px !important;
        border-bottom-right-radius: 20px !important;
    }

    /* ì˜¤ëŠ˜ ë‚ ì§œì˜ í•˜ì´ë¼ì´íŠ¸ ë°°ê²½ ì œê±° */
    .fc .fc-day-today {
        background: none !important;
    }

    /* ë‚ ì§œ ì…€ ì „ì²´ ë°°ê²½ ì œê±° */
    .fc .fc-daygrid-day-frame {
        background: none !important;
    }
    .btn-outline-dark.px-4.py-2 {
        background-color: white;
        border: 1px solid #A39F95;
        border-radius: 0;
        color: black;
        font-size: 16px;
        transition: all 0.2s ease;
    }

</style>
{% endblock %}

{% block scripts %}
    <script>
        let calendar;
        let clickCount = 0;
        let startDate = null;

        // ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        
        document.addEventListener("DOMContentLoaded", function () {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: "ko",
                height: 'auto',
                selectable: true,
                validRange: {
                    start: todayStr // ì˜¤ëŠ˜ ì´í›„ë¶€í„° ì„ íƒ ê°€ëŠ¥
                },
                events: [],
                dayCellContent: function(arg) {
                    return { html: String(arg.date.getDate()) };  // ìˆ«ìë§Œ ì¶œë ¥
                },
                dayCellDidMount: function(info) {
                    const dateStr = info.date.toISOString().split('T')[0]; // yyyy-mm-dd í˜•íƒœë¡œ
                    const events = calendar.getEvents().filter(e =>
                        e.classNames.includes('selected-day') &&
                        e.startStr === dateStr
                    );

                    if (events.length > 0) {
                        info.el.classList.add('selected-day');
                    } else {
                        info.el.classList.remove('selected-day');
                    }
                },
                eventDidMount: function (info) {
                    const start = info.event.start;
                    const end = info.event.end;

                    const startStr = start.toISOString().split('T')[0];
                    const endStr = end ? new Date(end.getTime() - 1).toISOString().split('T')[0] : null;

                    if (!end || startStr === endStr) {
                        info.el.classList.add('selected-day-single');
                    } else {
                        // FullCalendarëŠ” ê° ì…€ë§ˆë‹¤ event divë¥¼ ë„£ì–´ì¤Œ â†’ classNameìœ¼ë¡œ êµ¬ë¶„
                        if (info.el.classList.contains('fc-event-start')) {
                            info.el.classList.add('selected-day-start');
                        } else if (info.el.classList.contains('fc-event-end')) {
                            info.el.classList.add('selected-day-end');
                        } else {
                            info.el.classList.add('selected-day-middle');
                        }
                    }
                },
                dateClick: function (info) {
                    clickCount += 1;

                    if (clickCount === 1) {
                        startDate = new Date(info.date.getFullYear(), info.date.getMonth(), info.date.getDate());
                        calendar.addEvent({
                            start: startDate,
                            allDay: true,
                            classNames: ['selected-day']
                        });
                    } else if (clickCount === 2) {
                        const endDate = new Date(info.date.getFullYear(), info.date.getMonth(), info.date.getDate());
                        calendar.getEvents().forEach(e => e.remove());

                        let realStart = startDate < endDate ? startDate : endDate;
                        let realEnd = startDate > endDate ? startDate : endDate;
                        // fullCalendarëŠ” endë‚ ì§œë¥¼ í¬í•¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•˜ë£¨ ë”í•¨
                        const realEndMidnight = new Date(realEnd.getFullYear(), realEnd.getMonth(), realEnd.getDate());
                        const inclusiveEnd = new Date(realEndMidnight.getTime() + 24 * 60 * 60 * 1000);

                        const realStartStr = `${realStart.getFullYear()}-${String(realStart.getMonth() + 1).padStart(2, '0')}-${String(realStart.getDate()).padStart(2, '0')}`;
                        const inclusiveEndStr = `${inclusiveEnd.getFullYear()}-${String(inclusiveEnd.getMonth() + 1).padStart(2, '0')}-${String(inclusiveEnd.getDate()).padStart(2, '0')}`;

                        calendar.addEvent({
                            start: realStartStr,
                            end: inclusiveEndStr,
                            allDay: true,
                            classNames: ['selected-day']
                        });
                        
                        
                        // ë“œë¡­ë‹¤ìš´ì— ì‹œì‘ì¼ ë°˜ì˜
                        document.getElementById("start-year").value = realStart.getFullYear();
                        document.getElementById("start-month").value = realStart.getMonth() + 1;
                        document.getElementById("start-day").value = realStart.getDate();
                        
                        // ë“œë¡­ë‹¤ìš´ì— ì¢…ë£Œì¼ ë°˜ì˜
                        document.getElementById("end-year").value = realEnd.getFullYear();
                        document.getElementById("end-month").value = realEnd.getMonth() +1;
                        document.getElementById("end-day").value = realEnd.getDate();
                        
                        // ë‹¤ìŒ í´ë¦­ë¶€í„° ë‹¤ì‹œ ì‹œì‘
                        clickCount = 0;
                        startDate = null;                    
                    }
                }
            });
            
            calendar.render();
            
            ["start-year", "start-month"].forEach(id => {
                document.getElementById(id).addEventListener("change", () => {
                    const y = parseInt(document.getElementById("start-year").value);
                    const m = parseInt(document.getElementById("start-month").value);

                    if (!isNaN(y) && !isNaN(m)) {
                        calendar.gotoDate(new Date(y, m - 1, 1));
                    }
                });
                document.getElementById(id).addEventListener("change", disableDayOptions);
            });

            ["start-year", "start-month", "start-day", "end-year", "end-month", "end-day"].forEach(id => {
                document.getElementById(id).addEventListener("change", updateCalendar);
            });
            
            // ì‹œì‘ì¼ í•˜ì´ë¼ì´íŠ¸
            function renderStartDateHighlight(year, month, day) {
                if (!calendar) return;
    
                const start = new Date(year, month - 1, day);
                const startStr = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;
    
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
                calendar.getEvents().forEach(e => e.remove());
    
                // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
                calendar.addEvent({
                    start: realStartStr,
                    end: inclusiveEndStr,
                    allDay: true,
                    classNames: ['selected-day']
                });
            }

            ["start-year", "start-month", "start-day"].forEach(id => {
                document.getElementById(id).addEventListener("change", () => {
                    const y = parseInt(document.getElementById("start-year").value);
                    const m = parseInt(document.getElementById("start-month").value);
                    const d = parseInt(document.getElementById("start-day").value);

                    if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
                        renderStartDateHighlight(y, m, d);
                    }
                });
            })

            // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            disablePastDates();
            disableEndPastDates();
        });
        
        
        // ë“œë¡­ë‹¤ìš´ì—ì„œ ë‚ ì§œ ì„ íƒí•˜ë©´ ë‹¬ë ¥ ì—…ë°ì´íŠ¸
        function updateCalendar() {
            if (!calendar) return;

            const start_year = document.getElementById("start-year").value;
            const start_month = document.getElementById("start-month").value;
            const start_day = document.getElementById("start-day").value;
            const end_year = document.getElementById("end-year").value;
            const end_month = document.getElementById("end-month").value;
            const end_day = document.getElementById("end-day").value;
            
            // if (!(start_year && start_month && start_day && end_year && end_month && end_day)) return;
            if (
                isNaN(parseInt(start_year)) || isNaN(parseInt(start_month)) || isNaN(parseInt(start_day)) ||
                isNaN(parseInt(end_year)) || isNaN(parseInt(end_month)) || isNaN(parseInt(end_day))
            ) {
                return;
            }

            //ì›”, ì¼ì´ í•œ ìë¦¬ì¼ ë•Œ 01,02ì²˜ëŸ¼ 2ìë¦¬ë¡œ ë³´ì •
                const sm = String(start_month).padStart(2, '0');
                const sd = String(start_day).padStart(2, '0');
                const em = String(end_month).padStart(2, '0');
                const ed = String(end_day).padStart(2, '0');
                const startDateStr = `${start_year}-${sm}-${sd}`;
                const endDateStr = `${end_year}-${em}-${ed}`;

                const start = new Date(Number(start_year), Number(start_month) - 1, Number(start_day));
                const end = new Date(Number(end_year), Number(end_month) - 1, Number(end_day));


            if (start >= today && end >= start) {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
                calendar.getEvents().forEach(e => e.remove());

                // ì‹œì‘ì¼/ì¢…ë£Œì¼ ì¤‘ ì–´ë–¤ ê²ƒì´ ë¨¼ì €ì¸ì§€ ë¹„êµ
                const realStart = start < end ? start : end;
                const realEnd = start > end ? start : end;

                // fullcalendarëŠ” endë‚ ì§œë¥¼ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í•˜ë£¨ ë”í•´ì¤Œ
                const realEndMidnight = new Date(realEnd.getFullYear(), realEnd. getMonth(), realEnd.getDate());
                const inclusiveEnd = new Date(realEndMidnight.getTime() + 24 * 60 * 60 * 1000);
                
                // ë‚ ì§œë¥¼ ë¬¸ìì—´(YYYY-MM-DD)ë¡œ ë³€í™˜
                const realStartStr = `${realStart.getFullYear()}-${String(realStart.getMonth() + 1).padStart(2, '0')}-${String(realStart.getDate()).padStart(2, '0')}`;
                const inclusiveEndStr = `${inclusiveEnd.getFullYear()}-${String(inclusiveEnd.getMonth() + 1).padStart(2, '0')}-${String(inclusiveEnd.getDate()).padStart(2, '0')}`;


                // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì¶”ê°€
                calendar.addEvent({
                start: realStartStr,
                end: inclusiveEndStr,
                allDay: true,
                classNames: ['selected-day']
            });


            }
        }
        
        

        // ì‹œì‘ì¼ ë“œë¡­ë‹¤ìš´ì—ì„œ ê³¼ê±° ë‚ ì§œ ë¹„í™œì„±í™” ì²˜ë¦¬
        function disablePastDates() {
            // ì‹œì‘ì¼ ë“œë¡­ë‹¤ìš´ ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
            const yearSelect = document.getElementById("start-year");
            const monthSelect = document.getElementById("start-month");
            const daySelect = document.getElementById("start-day");
            
            // 1. ê³¼ê±° ì—°ë„ ë¹„í™œì„±í™”
            [...yearSelect.options].forEach(option => {
                if (option.value && parseInt(option.value) < yyyy) {
                    // í˜„ì¬ ì—°ë„ë³´ë‹¤ ê³¼ê±°ì¸ ì—°ë„ëŠ” ì„ íƒí•  ìˆ˜ ì—†ê²Œ ë¹„í™œì„±í™”
                    option.disabled = true;
                }
            });

            // 2. ì‹œì‘ì¼ ì—°ë„ê°€ ë³€ê²½ë˜ë©´ í•´ë‹¹ ì—°ë„ì— ë§ëŠ” ì›” ì˜µì…˜ë“¤ì„ í•„í„°ë§
            yearSelect.addEventListener("change", () => {
                const y = parseInt(yearSelect.value);
                [...monthSelect.options].forEach(option => {
                    if (option.value) {
                        const m = parseInt(option.value);
                        // ì„ íƒí•œ ì—°ë„ê°€ í˜„ì¬ ì—°ë„ë¼ë©´ í˜„ì¬ ì›”ë³´ë‹¤ ì´ì „ ì›”ì€ ë¹„í™œì„±í™”
                        option.disabled = (y === yyyy && m < today.getMonth() + 1);
                    }
                });
                // ì›”, ì¼ì´ ë°”ë€Œì—ˆìœ¼ë‹ˆ ì´ˆê¸°í™”
                monthSelect.value = "ì„ íƒ";
                daySelect.value = "ì„ íƒ";
                disableDayOptions();
            });

            // 3. ì‹œì‘ì¼ ì›”ì´ ë³€ê²½ë˜ë©´ í•´ë‹¹ ì›”ì— ë§ëŠ” ì¼ ì˜µì…˜ë“¤ì„ í•„í„°ë§
            monthSelect.addEventListener("change", disableDayOptions);
            daySelect.addEventListener("change", disableDayOptions);

            
            // ì²˜ìŒì—ë„ ê²€ì‚¬
            if (yearSelect.value !== "ì„ íƒ" && monthSelect.value !=="ì„ íƒ") {
                disableDayOptions();
            }
        }
        
        function disableDayOptions() {
            const yearSelect = document.getElementById("start-year");
            const monthSelect = document.getElementById("start-month");
            const daySelect = document.getElementById("start-day");

            const y = parseInt(yearSelect.value);
            const m = parseInt(monthSelect.value);

            if (!y || !m) return;

            [...daySelect.options].forEach(option => {
                if (!option.value) return;
                    const d = parseInt(option.value);
                    const selectedDate = new Date(y, m - 1, d);
                    //ì„ íƒí•œ ì—°ë„, ì›”ì´ í˜„ì¬ ì—°ë„, ì›”ì´ë¼ë©´ í˜„ì¬ ì¼ë³´ë‹¤ ì´ì „ ë‚ ì§œëŠ” ë¹„í™œì„±í™”
                    option.disabled = selectedDate < today;
            });
        }

        // ì¢…ë£Œì¼ ë“œë¡­ë‹¤ìš´ ì‹œì‘ì¼(ë˜ëŠ” ì˜¤ëŠ˜)ë³´ë‹¤ ì•ì´ë©´ ë¹„í™œì„±í™” ì²˜ë¦¬
        function disableEndPastDates() {
            // ì¢…ë£Œì¼ ë“œë¡­ë‹¤ìš´ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const endYear = document.getElementById("end-year");
            const endMonth = document.getElementById("end-month");
            const endDay = document.getElementById("end-day");

            // ì‹œì‘ì¼ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ ê°’ì„ ìˆ«ìë¡œ ê°€ì ¸ì˜¤ê¸°
            const startYear = parseInt(document.getElementById("start-year").value);
            const startMonth = parseInt(document.getElementById("start-month").value);
            const startDay = parseInt(document.getElementById("start-day").value);

            // ì‹œì‘ì¼ì´ ì™„ì „íˆ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢…ë£Œì¼ ê²€ì‚¬ X
            if (!startYear || !startMonth || !startDay) return;

            // ì‹œì‘ì¼ ê°ì²´ ìƒì„± (ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ -1)
            const startDate = new Date(startYear, startMonth - 1, startDay);

            // ì¢…ë£Œ ì—°ë„ ë¹„í™œì„±í™”
            [...endYear.options].forEach(option => {
                if (option.value) {
                const y = parseInt(option.value);
                // í˜„ì¬ ì—°ë„ë³´ë‹¤ ì‘ê±°ë‚˜ ì‹œì‘ì—°ë„ë³´ë‹¤ ì‘ìœ¼ë©´ ì„ íƒ ë¶ˆê°€
                option.disabled = y < startYear || y < today.getFullYear();
                }
        });

            // ì¢…ë£Œ ì›” ë³€ê²½ ì‹œ ì›” ì˜µì…˜ ì œí•œ
            endYear.addEventListener("change", () => {
                const y = parseInt(endYear.value);
                [...endMonth.options].forEach(option => {
                    if (option.value) {
                        const m = parseInt(option.value);
                        // ì‹œì‘ì—°ë„ì´ë©´ì„œ ì‹œì‘ì›”ë³´ë‹¤ ì´ì „ì´ë©´ ë¹„í™œì„±í™”
                        const disableByYear = y === startYear && m < startMonth;
                        // ì˜¤ëŠ˜ ì—°ë„ì´ë©´ì„œ ì˜¤ëŠ˜ ì›”ë³´ë‹¤ ì´ì „ì´ë©´ ë¹„í™œì„±í™”
                        const disableByToday = y === today.getFullYear() && m < today.getMonth() + 1;
                        option.disabled = disableByYear || disableByToday;
                    }
                });

                // ì›”/ì¼ ì´ˆê¸°í™” -> ì›”ì´ ë°”ë€Œë©´ ì¼ë„ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ í•„í„°ë§í•´ì•¼ í•˜ë¯€ë¡œ ì´ˆê¸°í™” í›„ ì¬ì ìš©
                endMonth.value = "ì„ íƒ";
                endDay.value = "ì„ íƒ";
                disableEndDays();
            });

            // ì¢…ë£Œ ì›” ë³€ê²½ ì‹œ ì¼ ì˜µì…˜ ì œí•œ
            endMonth.addEventListener("change", disableEndDays);

            function disableEndDays() {
                const y = parseInt(endYear.value);
                const m = parseInt(endMonth.value);
                if (!y || !m) return;

                const startYear = parseInt(document.getElementById("start-year").value);
                const startMonth = parseInt(document.getElementById("start-month").value);
                const startDay = parseInt(document.getElementById("start-day").value);
                if (!startYear || !startMonth || !startDay) return;

                const startDate = new Date(startYear, startMonth - 1, startDay);

                // ì¢…ë£Œ ì¼ ë“œë¡­ë‹¤ìš´ì˜ ê° ì˜µì…˜(ë‚ ì§œ)ì„ í™•ì¸
                [...endDay.options].forEach(option => {
                    if (!option.value) return;

                    const d = parseInt(option.value);
                    const endDate = new Date(y, m - 1, d);

                    option.disabled = endDate < startDate;
                });
            }

            // ì¢…ë£Œì¼ì˜ ì¼ ì„ íƒ ì‹œì ì—ì„œ ìœ íš¨ì„± ê²€ì‚¬
            endDay.addEventListener("change", () => {
                const y = parseInt(endYear.value);
                const m = parseInt(endMonth.value);
                const d = parseInt(endDay.value);


                if (!y || !m || !d) return;
                if (!startYear || !startMonth || !startDay) return;

                const endDate = new Date(y, m - 1, d);
                const startDate = new Date(startYear, startMonth - 1, startDay);

                // í˜„ì¬ ì„ íƒí•œ ê°’ì´ ìœ íš¨í•˜ì§€ ì•Šë‹¤ë©´ ì•Œë¦¼ì„ ë„ìš°ê³  ì´ˆê¸°í™”
                if (endDate < startDate) {
                    alert("ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    endDay.value = "ì„ íƒ";
                }
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            ["start-year", "start-month", "start-day"].forEach(id => {
                document.getElementById(id).addEventListener("change", () => {
                    disableDayOptions();
                    disableEndPastDates();
                    updateCalendar();
                    disableEndDays();
                });
            });

            ["end-year", "end-month", "end-day"].forEach(id => {
                document.getElementById(id).addEventListener("change", ()=> {
                    disableEndPastDates();
                    updateCalendar();
                })
            })
        });
    </script>

{% endblock%}