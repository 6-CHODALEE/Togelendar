{% extends 'base.html' %}

{% block body %}
<div class="container mt-4">
    <h3 class="fw-bold mb-4">{{album_name}}</h3>

    <!--filepond 업로드 input-->
    <input type="file" class="filepond" name="filepond" multiple data-max-files="10">

    <!--업로드된 이미지 썸네일 목록-->
    <div id="gallery" class="d-flex flex-wrap gap-3 mt-4">
        {% for photo in photos %}
        <img src="{{photo.image.url}}"
            class="album-image rounded"
            data-photo-id="{{photo.id}}"
            style="width: 150px; height: 150px; object-fit: cover; cursor: pointer;">
        {% endfor %}
    </div>

    <!--댓글창(사진 클릭 시 열림)-->
    <div id="commentBox" class="card mt-4" style="display: none; max-width: 500px;">
        <div class="card-body">
            <h5 class="card-title">오늘 어땠어?</h5>

            <form id="commentForm">
                <!--약속이 어땠는지-->
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mood" value="좋았어" id="mood1">
                    <label class="form-check-label" for="mood1">😊 좋았어</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mood" value="그냥 그랬어" id="mood2">
                    <label class="form-check-label" for="mood2">😐 그냥 그랬어</label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="mood" value="별로였어" id="mood3">
                    <label class="form-check-label" for="mood3">😞 별로였어</label>
                </div>

                <textarea id="commentInput" class="form-control mb-2" placeholder="댓글을 입력하세요" rows="2"></textarea>
                <button type="submit" class="btn btn-outline-primary btn-sm">댓글</button>
            </form>

            <div id="commentList" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!--FilePond 라이브러리-->
<link href="https://unpkg.com/filepond/dist/filepond.min.css" rel="stylesheet" />
<link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css" rel="stylesheet" />
<script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // FilePond 등록 및 서버 연결
        FilePond.registerPlugin(FilePondPluginImagePreview);
        FilePond.create(document.querySelector('.filepond'), {
            server: {
                process: '/upload/',
                revert: '/revert',
                headers: {
                    'X-CSRFToken': '{{csrf_token}}'
                }
            }
        });

        const gallery = document.getElementById('gallery');
        const commentBox = document.getElementById('commentBox');
        const commentInput = document.getElementById('commentInput');
        const commentList = document.getElementById('commentList');
        const commentForm = document.getElementById('commentForm');

        let selectedPhotoId = null;

        // 이미지 클릭 시 댓글창 표시
        gallery.addEventListener("click", function (e) {
            if (e.target.classList.contains("album-image")) {
                selectedPhotoId = e.target.dataset.photoId;
                commentBox.style.display = "block";
                commentInput.value = '';
                commentList.innerHTML = '';
            }    
        });

        // 댓글 저장
        commentForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const text = commentInput.value.trim();
            const mood = commentForm.querySelector("input[name='mood']:checked")?.value;

            if (text && mood && selectedPhotoId) {
                const item = document.createElement("div");
                item.innerHTML = `<strong>${mood}</strong> - ${text}`;
                commentList.appendChild(item);
                commentInput.value = '';
                commentForm.querySelector("input[name='mood']:checked").checked = false;
                }
            });
        });
</script>
{% endblock %}