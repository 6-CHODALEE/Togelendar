{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block body %}
    <div class="row align-items-start mb-4">
        <!-- ì™¼ìª½: í”„ë¡œí•„ + ì´ë¦„ -->
        <div class="col-auto d-flex">
            <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
            <!-- ì¤‘ì•™ ì •ë ¬ëœ í”„ë¡œí•„ ë°•ìŠ¤ -->
            <div class="text-center mb-4">
                <div class="profile-image-wrapper position-relative">
                  {% if me.profile_image %}
                      <img src="{{ me.profile_image.url }}"
                          class="rounded-circle"
                          style="width: 170px; height: 170px; object-fit: cover;"
                          alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                  {% else %}
                      <img src="{% static 'default_profile.png' %}"
                          class="rounded-circle"
                          style="width: 170px; height: 170px; object-fit: cover;"
                          alt="ê¸°ë³¸ ì´ë¯¸ì§€">
                  {% endif %}

                  <!-- âœ ë²„íŠ¼ì„ ì´ë¯¸ì§€ ìœ„ì— ìœ„ì¹˜ì‹œí‚´ -->
                <a href="{% url 'mypage:verify_password' me %}" class="circle-button edit-profile-button">âœ</a>

                </div>
                <!-- ì´ë¦„ -->
                <p class="fw-bold mb-1">{{ me.username }}</p>

                <!-- ë²„íŠ¼ 2ê°œ ìˆ˜í‰ ì •ë ¬ -->
                <div class="d-flex justify-content-center gap-2">
                    <p class="mb-2">
                        í•¨ì¹œ
                        <strong id="showFriendList" style="cursor:pointer;" class="fw-bold">
                            {{ friend_count }}ëª…
                        </strong>
                    </p>
                    <a href="#" id="togglePopover" class="custom-dotted-btn btn btn-sm position-relative">
                        í•¨ì¹œ ì¶”ê°€
                        {% if received_requests %}
                            <span class="badge-friend bg-danger text-white position-absolute top-0 start-100 translate-middle">
                                {{ received_requests|length }}
                            </span>
                        {% endif %}
                    </a>
                </div>
            </div>
            <div class="col ms-4">
                <div class="mx-auto" style="width: 100%; max-width: 1400px; min-width: 1000px;">
                    <!-- ìƒë‹¨: ì›” í‘œì‹œ + ì£¼ê°„ ì´ë™ ë²„íŠ¼ -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-end gap-2">
                          <h4 class="fw-bold mb-0">{{ week_dates.0|date:"Yë…„ nì›”" }}</h4>
                          <span class="text-muted" style="font-size: 1rem; margin-bottom: 2px;">
                            {{ week_dates.0|date:"m/d" }} ~ {{ week_dates.6|date:"m/d" }}
                          </span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                          <a href="?base_date={{ today|date:'Y-m-d' }}" class="go-today-btn">ì˜¤ëŠ˜ë¡œ ê°€ê¸°</a>
                          <a href="?base_date={{ prev_week }}" class="arrow-btn">
                            <span class="arrow-left"></span>
                          </a>
                          <a href="?base_date={{ next_week }}" class="arrow-btn">
                            <span class="arrow-right"></span>
                          </a>
                        </div>
                    </div>

                    <!-- ìº˜ë¦°ë” í…Œì´ë¸” -->
                    <table class="table calendar-table table-bordered text-center align-middle mb-0">
                        <thead>
                            <tr>
                                {% for label in weekday_labels %}
                                    <th class="fw-bold {% if label == 'ì¼' %}text-danger{% elif label == 'í† ' %}text-primary{% endif %}">
                                        {{ label }}
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                {% for date in week_dates %}
                                    <td>
                                        <div class="calendar-date text-muted small fw-bold">
                                            {{ date|date:"jì¼" }}
                                        </div>

                                        <div class="calendar-promises-wrapper">
                                            {% for result in weekly_promises|get_item:date %}
                                                <a href="{% url 'community:promise:promise_result' community_id=result.promise.community.id promise_id=result.promise.id %}"
                                                class="calendar-promise"
                                                title="{{ result.promise_name }}" style="color: rgb(1, 1, 1);">
                                                    {{ result.promise_name }}
                                                </a>
                                            {% empty %}
                                                <div class="small text-muted">ì•½ì† ì—†ìŒ</div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

            <!--ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ íŒì—…-->
            <div id="friendListPopover" class="popover-form" style="display: none;">
                <div class="popover-arrow"></div>
                <h6 class="fw-bold">í•¨ì¹œ ëª©ë¡</h6>
                <ul class="list-group">
                    {% for friend in friend_list %}
                        <li class="list-group-item">
                            {% if friend.from_user == request.user %}
                                {{friend.to_user.username}}
                            {% else %}
                                {{friend.from_user.username}}
                            {% endif %}
                        </li>
                        {% empty %}
                            <li class="list-group-item text-muted">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endfor %}
                </ul>
                <div class="text-end mt-2">
                    <button id="closeFriendListPopover" class="btn btn-sm btn-secondary">ë‹«ê¸°</button>
                </div>
            </div>
        

            <!-- âœ… íŒì—… í¼ -->
            <div id="popoverForm" class="popover-form">
                <div class="popover-arrow"></div>

                <form method="get" action="{% url 'mypage:search_friends' me %}" id="searchForm">
                    <label for="friendName" class="form-label mb-1 fw-bold">ë‹‰ë„¤ì„ ê²€ìƒ‰</label>
                    <div class="input-group mb-2">
                        <input type="text" name="q" class="form-control" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
                        <button class="btn btn-primary btn-sm" type="submit">ê²€ìƒ‰</button>
                    </div>
                    <input type="hidden" name="popup_open" id="popupOpenField" value="false">
                </form>

                <ul id="searchResults" class="list-group mt-2"></ul>

                <div class="d-flex justify-content-end mt-2">
                    <button type="button" class="btn btn-secondary btn-sm" id="closePopover">ë‹«ê¸°</button>
                </div>
                <div class="friend-requests mt-2">
                <h6 class="fw-bold">ì¹œêµ¬ ìš”ì²­</h6>
                {% if received_requests %}
                    {% for req in received_requests %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>{{ req.from_user.username }}ë‹˜ì´ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.</span>
                            <button class="btn btn-sm btn-success accept-btn" data-username="{{ req.from_user.username }}">ìˆ˜ë½í•˜ê¸°</button>
                            <button class="btn btn-sm btn-danger reject-btn" data-username="{{ req.from_user.username }}">ê±°ì ˆí•˜ê¸°</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            </div>    
        </div>

    </div>

    <!-- ì•„ë˜: ì»¤ë®¤ë‹ˆí‹° ë¦¬ìŠ¤íŠ¸ -->
    <!-- ì»¤ë®¤ë‹ˆí‹° ìƒë‹¨ ë°” -->
    <div class="container">
    <div class="d-flex justify-content-between align-items-center community-header-bar mt-4">
        <h5 class="mb-0">{{ me }}ì˜ ì»¤ë®¤ë‹ˆí‹° ë¦¬ìŠ¤íŠ¸</h5>
        <div class="d-flex gap-2">
        {% if invite_requests %}
            <a href="#" id="showInvitePopover" class="btn btn-outline-request btn-sm">
            ê°€ì…ìš”ì²­ {{ invite_requests|length }}ê±´
            </a>
        {% endif %}
        <a href="{% url 'mypage:create_community' me %}" class="btn btn-create btn-sm">
            ìƒì„±í•˜ê¸°
        </a>
        </div>
    </div>
    </div>


    <!--ì»¤ë®¤ë‹ˆí‹° ê°€ì… ìš”ì²­ íŒì—…-->
    <div id="invitePopover" class="popover-form" style="display: none;">
        <div class="popover-arrow"></div>
        <h6 class="fw-bold">ì»¤ë®¤ë‹ˆí‹° ê°€ì… ìš”ì²­</h6>
        {% for invite in invite_requests %}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>{{invite.community.community_name}} (by {{invite.from_user.username}})</span>
                <div>
                    <button class="btn btn-sm btn-success accept-invite-btn" data-id="{{invite.id}}">ìˆ˜ë½</button>
                    <button class="btn btn-sm btn-danger reject-invite-btn" data-id="{{invite.id}}">ê±°ì ˆ</button>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>

    <!-- ì»¤ë®¤ë‹ˆí‹° ë¦¬ìŠ¤íŠ¸ -->
    <div class="container mt-4">
        {% if communities %}
            {% for community in communities %}
            <div class="d-flex justify-content-between align-items-center community-card">
                <div>{{ community.community_name }}</div>
                <a href="{% url 'community:community_detail' community.id %}" class="btn btn-enter btn-sm">ì…ì¥í•˜ê¸°</a>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-community-message">
            ì°¸ì—¬ ì¤‘ì¸ ì»¤ë®¤ë‹ˆí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        {% endif %}
    </div>
</div>

<!-- âœ… Djangoì—ì„œ ë„˜ê¸´ ê²€ìƒ‰ ê²°ê³¼ JSON ì €ì¥ -->
{{ results|json_script:"search-results-data" }}

<!-- âœ… íŒì—… ìŠ¤íƒ€ì¼ -->
<style>
/* ìƒë‹¨ í—¤ë” êµ¬ë¶„ì„  */
.community-header-bar {
  border-bottom: 2px solid black;
  padding-bottom: 10px;
}

/* ê°€ì… ìš”ì²­ ë²„íŠ¼ */
.btn-outline-request {
  border: 2px solid #FFB8FF;
  border-radius: 20px;
  background-color: white;
  color: black;
  padding: 6px 14px;
  font-weight: bold;
}

/* ìƒì„±í•˜ê¸° ë²„íŠ¼ */
.btn-create {
  background-color: #FFB8FF;
  border: none;
  border-radius: 20px;
  color: black;
  padding: 6px 14px;
  font-weight: bold;
}

/* ì…ì¥í•˜ê¸° ë²„íŠ¼ */
.btn-enter {
  background-color: #FFB8FF;
  border: none;
  border-radius: 16px;
  color: black;
  padding: 6px 14px;
  font-weight: bold;
}

.no-community-message {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px; /* í•„ìš”ì— ë”°ë¼ ì¡°ì • */
  font-size: 1.1rem;
  color: #666;
}

/* ì»¤ë®¤ë‹ˆí‹° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.community-card {
  background-color: white;
  border: 1.5px solid #333;
  border-radius: 25px;
  padding: 16px 24px;
  margin-bottom: 16px;
}

.custom-dotted-btn {
  background-color: transparent !important;
  border: 1px solid #000000;  /* ì ì„  í…Œë‘ë¦¬, ìƒ‰ìƒì€ ì—°í•œ ë¶„í™ */
  color: black;
  border-radius: 12px;
  padding: 5px 10px;
  transition: all 0.2s ease-in-out;
}

.custom-dotted-btn:hover {
  background-color: #fff0fa;
  color: black;
}

.circle-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    line-height: 1;
}

.edit-profile-button {
  position: absolute;
  bottom: 0;
  right: 0;
  transform: translate(0%, 0%);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: transparent; 
  color: black;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
}
/* ì „ì²´ ë°°ê²½ ë° ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
body {
  font-family: "Arial Rounded MT Bold", sans-serif;
  background-color: #fff9fc;
}

/* âœ… í”„ë¡œí•„ ì„¹ì…˜ */
.profile-box {
  width: 220px;
  text-align: center;
  padding: 20px;
  font-family: "Arial Rounded MT Bold", sans-serif;
}
.profile-box img {
  width: 170px;
  height: 170px;
  object-fit: cover;
  border-radius: 50%;
  margin-bottom: 10px;
}
.profile-box .btn {
  font-size: 0.8rem;
  padding: 5px 10px;
  border-radius: 10px;
  background-color: #FFB8FF;
  color: black;
  border: none;
}
.profile-box .btn:hover {
  background-color: #fda9f7;
}

/* âœ… ë‹¬ë ¥ ìƒë‹¨ ìŠ¤íƒ€ì¼ */
.calendar-card {
  border: 2px solid #FFB8FF;
  border-radius: 30px;
  padding: 20px;
  background: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.go-today-btn {
  padding: 4px 12px;
  border: 2px solid #FFB8FF;
  border-radius: 20px;
  background: white;
  color: black;
  font-weight: bold;
  text-decoration: none;
}
.go-today-btn:hover {
  background: #ffe4fb;
}
.arrow-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
}
.arrow-left, .arrow-right {
  display: inline-block;
  width: 0;
  height: 0;
}
.arrow-left {
  border-top: 10px solid transparent;
  border-bottom: 10px solid transparent;
  border-right: 12px solid #FFB8FF;
}
.arrow-right {
  border-top: 10px solid transparent;
  border-bottom: 10px solid transparent;
  border-left: 12px solid #FFB8FF;
}

/* âœ… ìº˜ë¦°ë” í…Œì´ë¸” */
.calendar-table {
  width: 100%;
  table-layout: fixed;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid #eee;
  border-radius: 20px; 
  overflow: hidden;  
}
.calendar-table thead th {
  text-align: center;
  font-weight: bold;
  color: black;
  padding: 8px;
  border-bottom: 2px solid #f6f4f6;
}
.calendar-table thead th:first-child { color: red; }
.calendar-table thead th:last-child { color: blue; }
.calendar-table td {
  vertical-align: top;
  height: 120px;
  padding: 8px;
  border: 1px solid #eee;
  position: relative;
}
.calendar-date {
  position: absolute;
  top: 6px;
  right: 10px;
  font-size: 0.8rem;
  font-weight: bold;
  color: #888;
}
.calendar-promises-wrapper {
  margin-top: 24px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.calendar-promise {
  background-color: #c3f0ff;
  color: #000;
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* âœ… ì»¤ë®¤ë‹ˆí‹° ë¦¬ìŠ¤íŠ¸ */
.community-card {
  background: white;
  border: 2px solid #FFB8FF;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.community-card .btn {
  background-color: #FFB8FF;
  color: black;
  border: none;
  border-radius: 10px;
  padding: 5px 10px;
  font-weight: bold;
}
.community-card .btn:hover {
  background-color: #fda9f7;
}

/* âœ… íŒì—… ìŠ¤íƒ€ì¼ */
.popover-form {
  background: white;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 16px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  position: absolute;
  z-index: 1000;
  width: 400px;
}
</style>

<!-- âœ… íŒì—… ë™ì‘ ë° ê²€ìƒ‰ ê²°ê³¼ ì¶œë ¥ JS -->
<script>
const currentUsername = "{{ request.user.username }}";
const csrftoken = '{{ csrf_token }}';

const btn = document.getElementById("togglePopover");
const popover = document.getElementById("popoverForm");
const closeBtn = document.getElementById("closePopover");
const resultsContainer = document.getElementById("searchResults");
const searchForm = document.getElementById('searchForm');
const popupOpenField = document.getElementById('popupOpenField');

// âœ… ê²€ìƒ‰í•  ë•Œ í˜„ì¬ íŒì—… ìƒíƒœ ê¸°ë¡
searchForm.addEventListener('submit', () => {
    const isPopupOpen = window.getComputedStyle(popover).display !== "none";
    popupOpenField.value = isPopupOpen ? "true" : "false";
});

// âœ… ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ê°’ìœ¼ë¡œ ê²€ìƒ‰ í›„ íŒì—… ìƒíƒœ ë³µì›
const hasQuery = "{{ query|default:'' }}" !== "";
const shouldOpenPopover = "{{ open_popover|yesno:'true,false' }}" === "true";

if (hasQuery && shouldOpenPopover) {
    showPopover();  // ì›ë˜ íŒì—… ë„ìš°ê¸°
    setTimeout(() => {
        showPopover();  // ğŸ“Œ íŒì—… ìœ„ì¹˜ ì¬ì¡°ì •
    }, 10);  // ğŸ“Œ DOM ë Œë”ë§ ì´í›„ ì‹¤í–‰ë˜ë„ë¡ ë”œë ˆì´
} else {
    hidePopover();
}

// âœ… "í•¨ì¹œ ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ì—´ê¸° (ì„œë²„ ìƒíƒœ ë¬´ì‹œ)
btn.addEventListener("click", (e) => {
    e.preventDefault();
    showPopover();
});

function showPopover() {
    const button = document.getElementById("togglePopover");
    const popover = document.getElementById("popoverForm");

    const buttonRect = button.getBoundingClientRect();
    const popoverWidth = 70;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

    // ë¸Œë¼ìš°ì € ê¸°ì¤€ ì •ë ¬
    const left = buttonRect.left + scrollLeft + (buttonRect.width / 2) - (popoverWidth / 2);
    const top = buttonRect.bottom + scrollTop + 8;

    popover.style.position = "absolute";
    popover.style.top = `${top}px`;
    popover.style.left = `${Math.max(10, left)}px`;  // ì¢Œì¸¡ ì˜¤ë²„í”Œë¡œ ë°©ì§€
    popover.style.display = "block";
}

// âœ… íŒì—… ë‹«ê¸° í•¨ìˆ˜
function hidePopover() {
    popover.style.display = "none";
}

// âœ… ë‹«ê¸° ë²„íŠ¼
closeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    clearSearchState();
    hidePopover();

    // âœ… íŒì—… ë‹«ì„ ë•Œ URLì„ /mypage/<username>ìœ¼ë¡œ ê°•ì œ ì´ë™
    window.location.href = `/mypage/${currentUsername}/`;
});

// âœ… ê²€ìƒ‰ ìƒíƒœ ì´ˆê¸°í™”
function clearSearchState() {
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        searchInput.value = "";
    }
    popupOpenField.value = "false";
    resultsContainer.innerHTML = "";
    const cleanUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
}


// âœ… ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
const jsonDataElement = document.getElementById('search-results-data');

if (jsonDataElement) {
    const mockUsers = JSON.parse(jsonDataElement.textContent);

    if (mockUsers.length > 0) {
        resultsContainer.innerHTML = "";
        mockUsers.forEach(user => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            const infoSpan = document.createElement("span");
            infoSpan.innerHTML = `<strong>${user.username}</strong> (${user.email})`;

            const addButton = document.createElement("button");
            addButton.className = "btn btn-sm";

            // âœ… ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ ë³€ê²½
            if (user.request_status === 'pending') {
                addButton.textContent = "ìš”ì²­ ë³´ëƒ„";
                addButton.classList.add('btn-secondary');
                addButton.disabled = true;
            } else {
                addButton.textContent = "ìš”ì²­ë³´ë‚´ê¸°";
                addButton.classList.add('btn-primary');
                addButton.onclick = (e) => {
                    e.stopPropagation();
                    sendFriendRequest(user.username, addButton);
                };
            }

            li.appendChild(infoSpan);
            li.appendChild(addButton);
            resultsContainer.appendChild(li);
        });
    } else {
        resultsContainer.innerHTML = "<li class='list-group-item text-muted'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</li>";
    }
}

// âœ… ìš”ì²­ë³´ë‚´ê¸° Ajax í•¨ìˆ˜ (ì´ ë¶€ë¶„ ìƒˆë¡œ ì¶”ê°€ë¨!)
function sendFriendRequest(nickname, button) {
    fetch(`/mypage/${currentUsername}/friend/request/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken  // âœ… ì—¬ê¸°!
        },
        body: JSON.stringify({ to_username: nickname })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            addFriend(nickname, button);
        } else {
            alert("ì—ëŸ¬: " + data.error);
        }
    })
    .catch(err => {
        console.error(err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}

// âœ… ë²„íŠ¼ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function addFriend(nickname, button) {
    button.textContent = "ìš”ì²­ ë³´ëƒ„";
    button.className = "btn btn-sm btn-secondary";
    button.disabled = true;
    alert(`'${nickname}'ë‹˜ì—ê²Œ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
}


function acceptRequest(fromUsername, button) {  // âœ… button íŒŒë¼ë¯¸í„° ì¶”ê°€
    fetch(`/mypage/${currentUsername}/friend/accept/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ from_username: fromUsername })
    })
    .then(async res => {
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${text}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            acceptFriend(fromUsername, button);  // âœ… ì—¬ê¸°ì„œ button ì œëŒ€ë¡œ ì „ë‹¬
        } else {
            alert("ì—ëŸ¬: " + data.error);
        }
    })
    .catch(err => {
        console.error('ì—ëŸ¬ ë°œìƒ:', err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}

function acceptFriend(fromUsername, button) {
    // âœ… ìˆ˜ë½ ë²„íŠ¼ ë¹„í™œì„±í™”
    button.textContent = "ìˆ˜ë½ ì™„ë£Œ";
    button.className = "btn btn-sm btn-secondary";
    button.disabled = true;

    // âœ… ê°™ì€ ì¤„ì˜ ê±°ì ˆ ë²„íŠ¼ë„ ì°¾ì•„ì„œ ë¹„í™œì„±í™”
    const parent = button.closest('.d-flex');
    const rejectBtn = parent.querySelector('.reject-btn');
    if (rejectBtn) {
        rejectBtn.disabled = true;
        rejectBtn.classList.add('btn-secondary');
        rejectBtn.textContent = "ì²˜ë¦¬ë¨";
    }

    alert(`${fromUsername}ë‹˜ê³¼ ë§íŒ”ë¡œìš°ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

function rejectRequest(fromUsername, button) {
    fetch(`/mypage/${currentUsername}/friend/reject/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ from_username: fromUsername })
    })
    .then(async res => {
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${text}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            removeFriendRequestItem(button);
            alert(`${fromUsername}ë‹˜ì˜ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.`);
        } else {
            alert("ì—ëŸ¬: " + data.error);
        }
    })
    .catch(err => {
        console.error('ì—ëŸ¬ ë°œìƒ:', err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}

function removeFriendRequestItem(button) {
    button.closest('.d-flex').remove();
}

document.querySelectorAll('.accept-btn').forEach(button => {
    button.addEventListener('click', (e) => {
        e.stopPropagation();
        const fromUsername = button.dataset.username;
        acceptRequest(fromUsername, button);
    });
});


document.querySelectorAll('.reject-btn').forEach(button => {
    button.addEventListener('click', (e) => {
        e.stopPropagation();
        const fromUsername = button.dataset.username;
        rejectRequest(fromUsername, button);
    });
});

const inviteBtn = document.getElementById("showInvitePopover");
const invitePopover = document.getElementById("invitePopover");

if (inviteBtn && invitePopover) {
    inviteBtn.addEventListener("click", function (e) {
        e.preventDefault();
        const rect = inviteBtn.getBoundingClientRect();
        const popoverWidth = invitePopover.offsetWidth || 400;  // ì˜ˆìƒ íŒì—… ë„ˆë¹„
        let left = rect.left + window.scrollX;

        // í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚˜ë©´ ìœ„ì¹˜ ì¡°ì •
        const maxLeft = window.innerWidth - popoverWidth - 10;
        if (left > maxLeft) {
            left = maxLeft;
        }

        invitePopover.style.top = `${rect.bottom + window.scrollY + 5}px`;
        invitePopover.style.left = `${left}px`;
        invitePopover.style.display = "block";
    });
}

// ì»¤ë®¤ë‹ˆí‹° ê°€ì… ìš”ì²­ ìˆ˜ë½
document.querySelectorAll('.accept-invite-btn').forEach(button => {
    button.addEventListener('click', function () {
        const inviteId = button.getAttribute('data-id');
        
        fetch(`/mypage/${currentUsername}/respond_invite/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-CSRFToken': csrftoken,
            },
            body: JSON.stringify({invite_id: inviteId, action: 'accept'})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("ê°€ì… ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.");
                // ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì»¤ë®¤ë‹ˆí‹° ë¦¬ìŠ¤íŠ¸ ë°˜ì˜
                window.location.reload();
            }
        });
    });
});

// ì»¤ë®¤ë‹ˆí‹° ê°€ì… ìš”ì²­ ê±°ì ˆ
document.querySelectorAll('.reject-invite-btn').forEach(button => {
    button.addEventListener('click', function () {
        const inviteId = button.getAttribute('data-id');
        
        fetch(`/mypage/${currentUsername}/respond_invite/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ invite_id: inviteId, action: 'reject'})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("ê°€ì… ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
                window.location.reload();
                // í•´ë‹¹ ìš”ì²­ í•­ëª© ì‚­ì œ
                button.closest('.d-flex').remove();
                
                // ë‚¨ì€ ìš”ì²­ì´ ì—†ìœ¼ë©´ íŒì—… ë‹«ê¸°
                const remaining = document.querySelectorAll('.reject-invite-btn');
                if (remaining.length === 0) {
                    const invitePopover = document.getElementById("invitePopover");
                    if (invitePopover) invitePopover.style.display = "none";
                }
            } else {
                alert("ê±°ì ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
            }
        });
    });
});

// ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ íŒì—…ì°½
const showFriendList = document.getElementById("showFriendList");
const friendListPopover = document.getElementById("friendListPopover");

if (showFriendList && friendListPopover) {
    showFriendList.addEventListener("click", function (e) {
        const rect = showFriendList.getBoundingClientRect();
        friendListPopover.style.top = `${rect.bottom + window.scrollY - 50}px`;
        friendListPopover.style.left = `${rect.left + window.scrollX - 100}px`;
        friendListPopover.style.display = "block";
    });

    closeFriendListPopover.addEventListener("click", function () {
        friendListPopover.style.display = "none";
    });

}

// ì™¸ë¶€ í´ë¦­ ì‹œ íŒì—…ì°½ ë‹«ê¸°
// -> í•¨ì¹œì¶”ê°€, ê°€ì…ìš”ì²­ ë‘ê°œì˜ íŒì—… ë‹¤ ë‹«ëŠ” í†µí•© ë¡œì§
window.addEventListener("click", function (e) {
    // í•¨ì¹œ ì¶”ê°€ íŒì—… ì™¸ë¶€ í´ë¦­ ì²˜ë¦¬
    if (
        popover.style.display === "block" &&
        !popover.contains(e.target) &&
        e.target !== btn
    ) {
        clearSearchState();  // âœ… ê²€ìƒ‰ input ì´ˆê¸°í™” + results ë¹„ìš°ê¸°
        hidePopover();       // âœ… íŒì—… ìˆ¨ê¸°ê¸°
        window.location.href = `/mypage/${currentUsername}/`;  // âœ… ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” URL ì´ˆê¸°í™”
    }

    // ì»¤ë®¤ë‹ˆí‹° ê°€ì… ìš”ì²­ íŒì—…
    if (
        invitePopover.style.display === "block" &&
        !invitePopover.contains(e.target) &&
        e.target !== inviteBtn
    ) {
        invitePopover.style.display = "none";
    }

    // ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ íŒì—…
    if (
        friendListPopover.style.display === "block" &&
        !friendListPopover.contains(e.target) &&
        e.target !== showFriendList
    ) {
        friendListPopover.style.display = "none";
    }
});
</script>
{% endblock %}