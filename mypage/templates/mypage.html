{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block body %}
<style>

.calendar-cell {
  display: flex;
  flex-direction: column;
  justify-content: center; 
  align-items: center;     
  height: 100px;
  padding: 8px;
  text-align: center;
  border: 1px solid #ddd;
}

.calendar-date {
  font-size: 0.9rem;
  font-weight: bold;
  color: #888;
  margin-bottom: 6px;
}

.calendar-promise {
  background-color: #c3f0ff;
  color: #000000;
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 8px;
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.profile-image-wrapper {
    width: 170px;
    height: 170px;
    position: relative;
}

.edit-profile-button {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: #FFB8FF;
    color: black;
    border: none; /* 테두리 제거 */
    border-radius: 50%;
    padding: 6px 9px;
    font-size: 0.9rem;
    text-decoration: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.edit-profile-button:hover {
    background-color: #fda9f7;
}
.profile-box {
    width: 220px;
    background-color: transparent;
    border: none;
    box-shadow: none;
    border-radius: 20px;
    padding: 20px;
    text-align: center;
    font-family: "Arial Rounded MT Bold", sans-serif;
}
.profile-box img {
    width: 170px;
    height: 170px;
    object-fit: cover;
    border-radius: 50%;
    margin-bottom: 10px;
}
.profile-box p {
    margin-bottom: 6px;
}
.profile-box .btn {
    font-size: 0.8rem;
    padding: 5px 10px;
    border-radius: 10px;
}

/* 캘린더 카드 스타일 */
.calendar-card {
    background-color: #fff;
    border: 2px solid #FFB8FF;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    margin-top: 20px;
    border-radius: 30px;
}
.calendar-table {
    table-layout: fixed;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}
.calendar-table th,
.calendar-table td {
    width: 14.28%;
    vertical-align: top;
    height: 40px;
    padding: 8px;
    border: 1px solid #ddd;
}
.calendar-table thead th {
    background: none;
    border-bottom: 2px solid #FFB8FF;
    font-weight: bold;
}
.calendar-table thead th:first-child { color: red; }
.calendar-table thead th:last-child { color: blue; }
.calendar-date {
    font-size: 0.9rem;
    font-weight: bold;
    text-align: right;
    color: #888;
    height: 70px;
}
.calendar-promise {
    background-color: #c3f0ff;
    color: #0d6efd;
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 8px;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 6px;
}

/* 커뮤니티 리스트 헤더 */
.community-header {
    background-color: #fff0fa;
    border-top: 1.5px solid #FFB8FF;
    border-bottom: 1.5px solid #FFB8FF;
    border-radius: 0 0 10px 10px;
    padding: 10px 20px;
    margin-top: 40px;
    font-family: "Arial Rounded MT Bold", sans-serif;
}

/* 커뮤니티 카드 스타일 */
.community-card {
    background-color: #fdfdfd;
    border: 1.5px solid #ccc;
    border-radius: 20px;
    padding: 14px 20px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.community-card .btn {
    background-color: #FFB8FF;
    color: black;
    border: none;
    border-radius: 12px;
    padding: 5px 12px;
}
.community-card .btn:hover {
    background-color: #fda9f7;
}
</style>

<div class="container d-flex gap-5 mt-4">
  <!-- 프로필 박스 -->
  <div class="profile-box">
    <div class="profile-image-wrapper position-relative d-inline-block">
      {% if me.profile_image %}
      <img src="{{ me.profile_image.url }}" alt="프로필 이미지">
      {% else %}
      <img src="{% static 'default_profile.png' %}" alt="기본 이미지">
      {% endif %}

      <a href="{% url 'mypage:verify_password' me %}" class="edit-profile-button" title="프로필 편집">✎</a>
    </div>
    <p class="fw-bold">{{ me.username }}</p>
    <p>함친: <strong id="showFriendList">{{ friend_count }}명</strong>
      <a href="#" id="togglePopover" class="btn btn-secondary btn-sm position-relative">함친 추가</a>        
    </p>
  </div>

  <!-- 캘린더 카드 -->
  <div class="calendar-card flex-fill">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="fw-bold mb-0">{{ week_dates.0|date:"Y년 n월" }}</h4>
      <div class="d-flex gap-2 align-items-center">
        <a href="?base_date={{ prev_week }}" class="btn btn-outline-secondary btn-sm">&lt;</a>
        <span class="fw-bold">{{ base_date|date:"Y년 n월 j일" }} 기준 주</span>
        <a href="?base_date={{ next_week }}" class="btn btn-outline-secondary btn-sm">&gt;</a>
        <a href="?base_date={{ today|date:'Y-m-d' }}" class="btn btn-outline-primary btn-sm ms-2">오늘</a>
      </div>
    </div>
    <p class="mb-3">이번 주: {{ week_dates.0|date:"m/d" }} ~ {{ week_dates.6|date:"m/d" }}</p>
    <table class="table calendar-table mb-0">
      <thead>
        <tr>
          {% for label in weekday_labels %}
          <th class="{% if label == '일' %}text-danger{% elif label == '토' %}text-primary{% endif %}">{{ label }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr>
          {% for date in week_dates %}
          <td class="calendar-cell">
            <div class="calendar-date">{{ date|date:"j일" }}</div>
            {% for result in weekly_promises|get_item:date %}
            <a href="{% url 'community:promise:promise_result' community_id=result.promise.community.id promise_id=result.promise.id %}"
               class="calendar-promise">{{ result.promise_name }}</a>
            {% empty %}
            <div class="small text-muted" style="margin-top: 6px;">약속 없음</div>
            {% endfor %}
          </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 친구 리스트 팝업 등 기존 팝업 코드 유지 -->
{{ block.super }}

<!-- 커뮤니티 리스트 헤더 -->
<div class="container community-header d-flex justify-content-between align-items-center">
  <h5 class="mb-0">{{ me }}의 커뮤니티 리스트</h5>
  <div>
    {% if invite_requests %}
    <a href="#" id="showInvitePopover" class="btn btn-outline-secondary btn-sm me-2">
      가입 요청 {{ invite_requests|length }}건
    </a>
    {% endif %}
    <a href="{% url 'mypage:create_community' me %}" class="btn btn-pink btn-sm">생성하기</a>
  </div>
</div>

<!-- 커뮤니티 카드 리스트 -->
<div class="container mt-3">
  {% for community in communities %}
  <div class="community-card">
    <div>{{ community.community_name }}</div>
    <a href="{% url 'community:community_detail' community.id %}" class="btn btn-sm">입장하기</a>
  </div>
  {% empty %}
  <p class="text-muted">참여 중인 커뮤니티가 없습니다.</p>
  {% endfor %}
</div>

{% endblock %}